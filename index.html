<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-SOUNDING SYSTEM - PT. KALIMANTAN PRIMA PERSADA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        .container-card {
            max-width: 1400px;
            margin: 1rem auto;
            padding: 1.5rem;
            background: white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
        }
        .header-box {
            background: linear-gradient(135deg, #374151 0%, #6b7280 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 15px -3px rgba(55, 65, 81, 0.3);
        }
        .gold-gradient {
            background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
        }
        .form-label {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
            display: block;
            font-size: 0.9rem;
        }
        .input-field {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            width: 100%;
            transition: all 0.3s ease;
            background: white;
        }
        .input-field:focus {
            border-color: #f59e0b;
            outline: none;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        .drill-grid-area {
            display: grid;
            grid-template-columns: 60px repeat(30, minmax(25px, 1fr)); 
            border-top: 1px solid #e5e7eb;
            overflow-x: auto;
            min-width: 100%;
            background-color: white;
            font-size: 0.55rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .grid-header-cell {
            padding: 0.4rem 0.2rem;
            text-align: center;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            font-weight: 600;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
        }

        .grid-row-header {
            padding: 0.4rem 0.2rem;
            text-align: center;
            font-weight: 700;
            background: linear-gradient(135deg, #e2e8f0 0%, #f1f5f9 100%);
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            position: sticky;
            left: 0;
            z-index: 20;
            font-size: 0.65rem;
        }

        .row-count-cell {
            padding: 0.4rem 0.2rem;
            text-align: center;
            font-weight: 600;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            position: sticky;
            left: 50px;
            z-index: 15;
            font-size: 0.6rem;
            color: #92400e;
        }

        .hole-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2px 0;
            height: 45px;
            border-bottom: 1px solid #f3f4f6;
            position: relative;
            transition: background-color 0.2s ease;
        }

        .hole-cell:hover {
            background-color: #f8fafc;
        }

        .staggered-row-content {
            display: flex;
            flex-direction: column;
            width: 100%;
            align-items: center;
            justify-content: center;
        }

        [data-row-index="1"] .staggered-row-content,
        [data-row-index="3"] .staggered-row-content,
        [data-row-index="5"] .staggered-row-content,
        [data-row-index="7"] .staggered-row-content,
        [data-row-index="9"] .staggered-row-content,
        [data-row-index="11"] .staggered-row-content,
        [data-row-index="13"] .staggered-row-content,
        [data-row-index="15"] .staggered-row-content {
            transform: translateX(12px);
        }
        
        .hole-dot {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.55rem;
            line-height: 1;
            width: 22px;
            height: 22px;
            font-weight: 700;
            cursor: pointer;
            border-radius: 50%;
        }
        .hole-dot:hover {
            transform: scale(1.3);
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        }
        
        .hole-dot.status-D { 
            background: linear-gradient(135deg, #34d399 0%, #059669 100%);
            border: 2px solid #059669;
            color: white;
        }
        .hole-dot.status-W { 
            background: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%);
            border: 2px solid #2563eb;
            color: white;
        }
        .hole-dot.status-C { 
            background: linear-gradient(135deg, #fca5a5 0%, #ef4444 100%);
            border: 2px solid #ef4444;
            color: white;
        }
        
	.hole-modal {
	    position: fixed;
	    top: 50%;
	    left: 50%;
	    transform: translate(-50%, -50%);
	    z-index: 1000;
	    background: white;
	    border: 1px solid #ccc;
	    border-radius: 12px;
	    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2);
	    padding: 1.5rem;
	    width: 280px;
	    animation: modalAppear 0.3s ease-out;
	}

        @keyframes modalAppear {
            from { opacity: 0; transform: scale(0.9) translateY(-10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .signature-container {
            position: relative;
            width: 100%;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        #signatureCanvas {
            width: 100% !important;
            height: 150px !important;
            display: block;
            cursor: crosshair;
            background: white;
            touch-action: none;
            border: 1px solid #e5e7eb;
        }

        .signature-clear-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            z-index: 10;
        }

        .signature-clear-btn:hover {
            background: rgba(220, 38, 38, 0.9);
        }

        .signature-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #9ca3af;
            font-style: italic;
            pointer-events: none;
            z-index: 1;
        }

        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
        }

        .user-info {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .hidden {
            display: none !important;
        }

        .content-section {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .nav-btn.active {
            border-color: #d97706;
            box-shadow: 0 10px 15px -3px rgba(217, 119, 6, 0.3);
            background: white !important;
            color: #92400e !important;
        }

        /* KOMPAS STYLES SEDERHANA */
        .compass-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            border: 1px solid #cbd5e1;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .compass-title {
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #1e293b;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .compass-wrapper {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }
        
        .compass-base {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border: 2px solid #9ca3af;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .compass-center {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-radius: 50%;
            z-index: 10;
        }
        
        .compass-axis {
            position: absolute;
            background-color: #6b7280;
            border-radius: 2px;
        }
        
        .compass-axis-horizontal {
            width: 160px;
            height: 4px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .compass-axis-vertical {
            width: 4px;
            height: 160px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .compass-direction {
            position: absolute;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            color: #6b7280;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 5;
        }
        
        .compass-direction:hover {
            transform: scale(1.1);
            background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
        }
        
        .compass-direction.active {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.5);
        }
        
        .compass-direction.active::after {
            content: "U";
            font-size: 1rem;
        }
        
        .compass-direction.north {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .compass-direction.east {
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
        }
        
        .compass-direction.south {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .compass-direction.west {
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
        }

        /* IMPORT/EXPORT SECTION */
        .import-export-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid #cbd5e1;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .custom-notification {
            transform: translateX(100%);
        }
        .premium-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .premium-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border-color: #f59e0b;
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="bg-gradient-to-r from-gray-800 to-gray-600 text-white shadow-2xl mb-6 rounded-2xl overflow-hidden mx-4 mt-4">
        <div class="container mx-auto px-6 py-4">
            <div class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold mb-2 tracking-tight">
                    <span class="bg-clip-text text-transparent bg-gradient-to-r from-gray-200 to-gray-100">
                        PT. KALIMANTAN PRIMA PERSADA
                    </span>
                </h1>
                <h2 class="text-xl md:text-2xl font-semibold text-gray-100">DISTRIK INDE - E-SOUNDING SYSTEM</h2>
                <p class="text-gray-200 mt-2 text-sm">Digital Blast Hole Monitoring & Reporting</p>
            </div>

            <nav class="flex flex-wrap justify-center gap-3 mb-2" id="mainNavigation">
                <button data-section="home" class="nav-btn active px-5 py-3 bg-white text-gray-800 font-semibold rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
                    üè† HOME
                </button>
                <button data-section="e-sounding" class="nav-btn px-5 py-3 bg-gray-700 text-white font-semibold rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 hover:bg-gray-600">
                    üìä E-SOUNDING
                </button>
                <button data-section="preview" class="nav-btn px-5 py-3 bg-gray-700 text-white font-semibold rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 hover:bg-gray-600">
                    üëÅÔ∏è PREVIEW
                </button>
                <button data-section="database" class="nav-btn px-5 py-3 bg-gray-700 text-white font-semibold rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 hover:bg-gray-600">
                    üíæ DATABASE
                </button>
                <button id="loginBtn" class="px-5 py-3 bg-blue-600 text-white font-semibold rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 hover:bg-blue-500">
                    üîê LOGIN
                </button>
            </nav>
        </div>
    </header>

    <!-- LOGIN MODAL -->
    <div id="loginModal" class="login-modal hidden">
        <div class="login-container">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Login Sistem</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" id="username" class="input-field" placeholder="Masukkan username">
                </div>
                <div class="mb-6">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" id="password" class="input-field" placeholder="Masukkan password">
                </div>
                <div class="flex justify-between">
                    <button type="button" id="cancelLoginBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">
                        Batal
                    </button>
                    <button type="submit" class="px-4 py-2 gold-gradient text-white rounded-lg hover:shadow-lg transition">
                        Login
                    </button>
                </div>
            </form>
            </div>
        </div>
    </div>

    <div class="container-card">

        <!-- HOME SECTION -->
        <div id="homeSection" class="content-section">
            <div class="text-center py-8">
                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-3xl p-8 shadow-2xl border border-gray-200">
                    <h1 class="text-4xl font-bold text-gray-900 mb-6">üöÄ WELCOME TO E-SOUNDING SYSTEM</h1>
                    <p class="text-xl text-gray-700 mb-8">Digital Solution for Blast Hole Monitoring & Reporting</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="premium-card p-6" onclick="showSection('e-sounding')">
                            <div class="text-4xl mb-4">üìä</div>
                            <h3 class="font-bold text-gray-800 mb-3 text-lg">E-SOUNDING</h3>
                            <p class="text-sm text-gray-600">Input data sounding dengan visualisasi grid interaktif dan import dari Excel</p>
                            <div class="mt-3 text-amber-600 font-semibold">Klik untuk mulai ‚Üí</div>
                        </div>
                        <div class="premium-card p-6" onclick="showSection('preview')">
                            <div class="text-4xl mb-4">üëÅÔ∏è</div>
                            <h3 class="font-bold text-gray-800 mb-3 text-lg">PREVIEW</h3>
                            <p class="text-sm text-gray-600">Lihat hasil visualisasi dan data historis dengan statistik lengkap</p>
                            <div class="mt-3 text-amber-600 font-semibold">Klik untuk melihat ‚Üí</div>
                        </div>
                        <div class="premium-card p-6 gold-gradient text-white" onclick="showSection('database')">
                            <div class="text-4xl mb-4">üíæ</div>
                            <h3 class="font-bold mb-3 text-lg">DATABASE</h3>
                            <p class="text-sm text-amber-100">Lihat dan kelola semua data sounding yang pernah diinput</p>
                            <div class="mt-3 text-amber-200 font-semibold">Klik untuk mengelola ‚Üí</div>
                        </div>
                    </div>
                    
                    <button data-section="e-sounding" class="nav-section-btn px-8 py-4 gold-gradient text-white font-bold rounded-2xl shadow-2xl hover:shadow-3xl transition-all duration-300 transform hover:scale-105 text-lg">
                        üöÄ START E-SOUNDING
                    </button>
                </div>
            </div>
        </div>

        <!-- E-SOUNDING SECTION -->
        <div id="e-soundingSection" class="content-section hidden">
            <!-- FORM INPUT -->
            <div id="generalInfoInputs" class="grid grid-cols-1 md:grid-cols-5 gap-4 p-6 mb-6 border border-gray-200 rounded-xl bg-gray-50">
                <div><label for="tanggal" class="form-label">Tanggal</label><input type="date" id="tanggal" class="input-field"></div>
                <div>
                    <label for="shift" class="form-label">SHIFT</label>
                    <select id="shift" class="input-field">
                        <option value="">Pilih Shift</option>
                        <option value="SHIFT 1">SHIFT 1</option>
                        <option value="SHIFT 2">SHIFT 2</option>
                    </select>
                </div>
                <div>
                    <label for="pit" class="form-label">PIT</label>
                    <select id="pit" class="input-field">
                        <option value="Tempudo 2">Tempudo 2</option>
                        <option value="Tempudo 3">Tempudo 3</option>
                        <option value="Tempudo 4">Tempudo 4</option>
                    </select>
                </div>
                <div><label for="lokasi" class="form-label">Lokasi</label><input type="text" id="lokasi" class="input-field" placeholder="Lokasi Blok"></div>
                <div><label for="planHole" class="form-label">Plan Hole</label><input type="number" id="planHole" class="input-field" placeholder="Jumlah Plan"></div>
                <div><label for="namaCrew" class="form-label">Nama Crew</label><input type="text" id="namaCrew" class="input-field" placeholder="Nama Crew"></div>
                <div><label for="namaGL" class="form-label">Nama GL</label><input type="text" id="namaGL" class="input-field" placeholder="Nama Group Leader"></div>
                <div><label for="burden" class="form-label">Burden (m)</label><input type="number" step="0.1" id="burden" class="input-field" placeholder="B"></div>
                <div><label for="spasi" class="form-label">Spasi (m)</label><input type="number" step="0.1" id="spasi" class="input-field" placeholder="S"></div>
                <div><label for="unitDrilling" class="form-label">Unit Drilling</label><input type="text" id="unitDrilling" class="input-field" placeholder="Unit"></div>
            </div>

            <!-- KOMPAS SEDERHANA -->
            <div class="compass-container">
                <div class="compass-title">Pilih Arah Utara dengan mengklik salah satu arah pada kompas:</div>
                
                <div class="compass-wrapper">
                    <div class="compass-axis compass-axis-horizontal"></div>
                    <div class="compass-axis compass-axis-vertical"></div>
                    
                    <div class="compass-base">
                        <div class="compass-center"></div>
                    </div>
                    
                    <div class="compass-direction north" data-direction="^"></div>
                    <div class="compass-direction east" data-direction=">"></div>
                    <div class="compass-direction south" data-direction="v"></div>
                    <div class="compass-direction west" data-direction="<"></div>
                </div>
            </div>

            <!-- IMPORT/EXPORT -->
            <div class="import-export-section">
                <h3 class="text-xl font-bold mb-4 text-gray-800 text-center">üìä IMPORT/EXPORT DATA</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- IMPORT EXCEL -->
                    <div class="border border-amber-300 rounded-xl p-5 bg-amber-50">
                        <h4 class="font-bold mb-3 text-amber-800 text-lg">üì• IMPORT FROM EXCEL</h4>
                        <p class="text-sm text-gray-600 mb-4">Format: ID HOLE, DEPTH HOLE (m), HOLE CONDITION</p>
                        
                        <div class="mb-4">
                            <button id="clearAllHolesBtn" class="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition flex items-center justify-center font-semibold mb-2">
                                üóëÔ∏è HAPUS SEMUA DATA LUBANG
                            </button>
                            <p class="text-xs text-red-600 text-center">Klik untuk menghapus semua data lubang sebelum import</p>
                        </div>
                        
                        <input type="file" id="excelImport" accept=".xlsx,.xls" 
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-amber-50 file:text-amber-700 hover:file:bg-amber-100 mb-4" />
                        
                        <button id="importExcelBtn" class="w-full px-4 py-3 gold-gradient text-white rounded-lg hover:shadow-lg transition flex items-center justify-center font-semibold">
                            <span>üöÄ IMPORT & AUTO-FILL GRID</span>
                        </button>
                        
                        <div id="importPreview" class="mt-4 hidden">
                            <div class="text-sm font-semibold text-amber-700 mb-2">Preview Import:</div>
                            <div id="importPreviewContent" class="text-xs bg-white p-3 border rounded-lg mt-1 max-h-24 overflow-y-auto"></div>
                            <button id="confirmImportBtn" class="mt-3 w-full px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition font-semibold">
                                ‚úÖ Konfirmasi Import Data
                            </button>
                        </div>
                    </div>

                    <!-- EXPORT EXCEL -->
                    <div class="border border-gray-300 rounded-xl p-5 bg-gray-50">
                        <h4 class="font-bold mb-3 text-gray-800 text-lg">üì§ EXPORT TO EXCEL</h4>
                        <p class="text-sm text-gray-600 mb-4">Download template atau export data existing</p>
                        
                        <div class="grid grid-cols-1 gap-3">
                            <button id="downloadTemplateBtn" class="w-full px-4 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition font-semibold">
                                üìã Download Template Excel
                            </button>
                            <button id="exportExcelBtn" class="w-full px-4 py-3 gold-gradient text-white rounded-lg hover:shadow-lg transition font-semibold">
                                üíæ Export Data ke Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GRID LUBANG -->
            <div class="overflow-x-auto mb-6">
                <h3 class="text-md font-bold mb-1 text-gray-700">Visualisasi Kondisi Lubang (Staggered Pattern)</h3>
                <div id="drillGrid" class="drill-grid-area bg-white rounded-lg border border-gray-300">
                    <!-- Grid akan diisi oleh JavaScript -->
                </div>
            </div>

            <!-- TANDA TANGAN -->
            <div class="mt-8 border-t pt-6">
                <h3 class="text-lg font-bold mb-4 text-gray-700">Tanda Tangan (TTD) - Pemeriksa</h3>
                
                <div class="signature-container">
                    <canvas id="signatureCanvas"></canvas>
                    <div class="signature-placeholder" id="signaturePlaceholder">
                        Gambar tanda tangan di area ini menggunakan mouse/touch...
                    </div>
                    <button class="signature-clear-btn" id="clearSignatureBtnSmall">
                        Hapus
                    </button>
                </div>
                
                <div class="flex space-x-4 mt-4">
                    <button id="clearSignatureBtn" class="flex-1 px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-200">
                        Hapus TTD
                    </button>
                    <button id="saveDataBtn" class="flex-1 px-4 py-2 gold-gradient text-white font-semibold rounded-lg hover:shadow-lg transition duration-200">
                        Simpan Data Sementara
                    </button>
                </div>
            </div>

            <!-- TOMBOL ACTION -->
            <div class="mt-8 pt-6 border-t">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <button id="generatePdfBtn" class="w-full px-4 py-3 gold-gradient text-white font-bold rounded-lg hover:shadow-lg transition duration-200 shadow-md">
                        üìÑ DOWNLOAD PDF
                    </button>
                    <button id="exportExcelBtn2" class="w-full px-4 py-3 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-700 transition duration-200 shadow-md">
                        üìä EXPORT EXCEL
                    </button>
                    <button id="generateFinalReportBtn" class="w-full px-4 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition duration-200 shadow-md">
                        üöÄ SIMPAN KE DATABASE
                    </button>
                </div>
            </div>
        </div>

        <!-- PREVIEW SECTION -->
        <div id="previewSection" class="content-section hidden">
            <div class="bg-white rounded-2xl p-8 shadow-2xl border border-gray-200">
                <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">üëÅÔ∏è DATA PREVIEW</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-gray-50 rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üìã Data Saat Ini</h3>
                        <div id="currentData" class="space-y-3">
                            <div class="bg-white rounded-xl p-4 shadow border border-gray-200">
                                <div class="text-sm text-gray-600">Isi data di section E-SOUNDING untuk melihat preview</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-amber-50 rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-amber-800 mb-4">üìà Statistik</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Total Lubang:</span>
                                <span class="font-bold text-gray-700" id="statTotalHoles">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Rata-rata Kedalaman:</span>
                                <span class="font-bold text-amber-700" id="statAvgDepth">0.0 m</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Kondisi Kering:</span>
                                <span class="font-bold text-green-700" id="statDryPercentage">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DATABASE SECTION -->
        <div id="databaseSection" class="content-section hidden">
            <div class="bg-white rounded-2xl p-8 shadow-2xl border border-gray-200">
                <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">üíæ DATABASE</h2>
                
                <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-xl">
                    <h3 class="text-xl font-bold mb-4 text-blue-800 text-center">Database Terpusat</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button id="syncDatabaseBtn" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold">
                            üîÑ Refresh Database
                        </button>
                        <button id="clearLocalDatabaseBtn" class="w-full px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold">
                            üóëÔ∏è Hapus Data Lokal
                        </button>
                    </div>
                </div>

                <div id="userInfoSection" class="user-info hidden">
                    <div>
                        <span id="userRoleDisplay" class="font-semibold"></span>
                        <span id="userNameDisplay" class="text-gray-600 ml-2"></span>
                    </div>
                    <button id="logoutBtn" class="logout-btn">
                        Logout
                    </button>
                </div>

                <div id="dbResults" class="space-y-6">
                    <div class="text-center p-8 bg-gray-50 rounded-xl">
                        <div class="text-4xl mb-4">üìä</div>
                        <h3 class="text-xl font-bold text-gray-700 mb-2">Database</h3>
                        <p class="text-gray-600">Data akan ditampilkan di sini setelah sinkronisasi</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

<!-- MODAL INPUT LUBANG -->
<div id="holeModal" class="hole-modal hidden">
    <h4 class="font-bold mb-3 text-lg text-gray-800" id="modalHoleId">Hole: A-1</h4>
    
    <div class="mb-4">
        <label for="holeDepth" class="form-label text-sm">Kedalaman (m):</label>
        <input type="number" step="0.1" id="holeDepth" class="input-field" placeholder="0.0">
    </div>

    <div class="mb-4">
        <label for="holeCondition" class="form-label text-sm">Kondisi Lubang:</label>
        <select id="holeCondition" class="input-field">
            <option value="">Pilih Kondisi</option>
            <option value="Kering">Kering</option>
            <option value="Basah">Basah</option>
            <option value="Collapse">Collapse</option>
        </select>
    </div>

    <div class="flex space-x-2">
        <button id="saveHoleDataBtn" class="flex-1 px-3 py-2 gold-gradient text-white text-sm font-semibold rounded-lg hover:shadow-lg transition duration-200">
            Simpan
        </button>
        <button id="closeHoleModalBtn" class="flex-1 px-3 py-2 bg-gray-300 text-gray-800 text-sm font-semibold rounded-lg hover:bg-gray-400 transition duration-200">
            Batal
        </button>
    </div>
</div>

    <!-- SCRIPT UTAMA -->
    <script>
    // VARIABEL GLOBAL
    let signaturePad;
    let currentHoleId = null;
    let currentNorthDirection = null;
    let holeData = {};
    let importData = null;
    let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');

    const HOLE_ROWS = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O'];
    const MAX_COLUMNS = 30;

    const USERS = {
        'admin': { password: 'admin123', role: 'admin', name: 'Administrator' },
        'user': { password: 'user123', role: 'user', name: 'Regular User' }
    };

    // INISIALISASI APLIKASI
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Initializing E-Sounding System...');
        initializeApp();
        initializeEventListeners();
        generateDrillGrid();
        loadSessionData();
    });

    function initializeApp() {
        // Set tanggal default
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('tanggal').value = today;
        
        // Initialize Signature Pad
        const canvas = document.getElementById('signatureCanvas');
        if (canvas) {
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgba(255, 255, 255, 0)',
                penColor: 'rgb(0, 0, 0)',
                minWidth: 1.5,
                maxWidth: 3,
                throttle: 16
            });
            
            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                
                // Redraw if there was a signature
                const savedSignature = localStorage.getItem('sounding_signature');
                if (savedSignature) {
                    const img = new Image();
                    img.onload = function() {
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        document.getElementById('signaturePlaceholder').style.display = 'none';
                    };
                    img.src = savedSignature;
                } else {
                    signaturePad.clear();
                }
            }
            
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            
            signaturePad.addEventListener('beginStroke', () => {
                document.getElementById('signaturePlaceholder').style.display = 'none';
            });
        }

        // Initialize Compass
        const compassDirections = document.querySelectorAll('.compass-direction');
        compassDirections.forEach(direction => {
            direction.addEventListener('click', function() {
                compassDirections.forEach(dir => dir.classList.remove('active'));
                this.classList.add('active');
                currentNorthDirection = this.getAttribute('data-direction');
                console.log('North direction set to:', currentNorthDirection);
                showNotification('ARAH MATA ANGIN TELAH DITAMBAHKAN');
            });
        });

        // Initialize Navigation
        const navButtons = document.querySelectorAll('.nav-btn, .nav-section-btn');
        navButtons.forEach(button => {
            button.addEventListener('click', function() {
                const sectionName = this.getAttribute('data-section');
                if (sectionName) {
                    showSection(sectionName);
                }
            });
        });

        // Home section cards
        const homeCards = document.querySelectorAll('.premium-card');
        homeCards.forEach(card => {
            card.addEventListener('click', function() {
                showSection('e-sounding');
            });
        });

        showSection('home');
    }

    function initializeEventListeners() {
        // Login/Logout
        document.getElementById('loginBtn').addEventListener('click', showLoginModal);
        document.getElementById('cancelLoginBtn').addEventListener('click', hideLoginModal);
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);

        // Hole Modal
        document.getElementById('saveHoleDataBtn').addEventListener('click', saveHoleData);
        document.getElementById('closeHoleModalBtn').addEventListener('click', closeHoleModal);

        // Signature
        document.getElementById('clearSignatureBtn').addEventListener('click', clearSignature);
        document.getElementById('clearSignatureBtnSmall').addEventListener('click', clearSignature);

        // Import/Export
        document.getElementById('importExcelBtn').addEventListener('click', handleExcelImport);
        document.getElementById('confirmImportBtn').addEventListener('click', confirmImport);
        document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
        document.getElementById('exportExcelBtn2').addEventListener('click', exportToExcel);
        document.getElementById('downloadTemplateBtn').addEventListener('click', downloadTemplate);
        document.getElementById('clearAllHolesBtn').addEventListener('click', clearAllHoles);

        // Database
        document.getElementById('syncDatabaseBtn').addEventListener('click', syncDatabase);
        document.getElementById('clearLocalDatabaseBtn').addEventListener('click', clearLocalDatabase);

        // Report Generation
        document.getElementById('saveDataBtn').addEventListener('click', saveData);
        document.getElementById('generatePdfBtn').addEventListener('click', generatePdf);
        document.getElementById('generateFinalReportBtn').addEventListener('click', generateFinalReport);

        // Form auto-save
        const formInputs = document.querySelectorAll('#generalInfoInputs input, #generalInfoInputs select');
        formInputs.forEach(input => {
            input.addEventListener('change', saveSessionData);
        });
    }

    // FUNGSI NAVIGASI
    function showSection(sectionName) {
        console.log('Showing section:', sectionName);
        
        // Sembunyikan semua section
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.add('hidden');
        });
        
        // Update navigation buttons
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-white', 'text-gray-800');
            btn.classList.add('bg-gray-700', 'text-white');
        });
        
        // Tampilkan section yang dipilih
        const targetSection = document.getElementById(sectionName + 'Section');
        if (targetSection) {
            targetSection.classList.remove('hidden');
        }
        
        // Update active button
        const activeButton = document.querySelector(`[data-section="${sectionName}"]`);
        if (activeButton) {
            activeButton.classList.remove('bg-gray-700', 'text-white');
            activeButton.classList.add('active', 'bg-white', 'text-gray-800');
        }

        // Auto-refresh data di section preview
        if (sectionName === 'preview') {
            updatePreviewData();
        }
        
        // Auto-sync database jika admin
        if (sectionName === 'database' && currentUser && currentUser.role === 'admin') {
            syncDatabase();
        }
    }

    // FUNGSI GRID LUBANG
    function generateDrillGrid() {
        const drillGrid = document.getElementById('drillGrid');
        if (!drillGrid) return;

        let gridHTML = '';

        // Header row
        gridHTML += '<div class="grid-header-cell" style="grid-row: 1; grid-column: 1;"></div>';
        gridHTML += '<div class="grid-header-cell" style="grid-row: 1; grid-column: 2;">COUNT</div>';
        
        for (let col = 1; col <= MAX_COLUMNS; col++) {
            gridHTML += `<div class="grid-header-cell" style="grid-row: 1; grid-column: ${col + 2};">${col}</div>`;
        }

        // Data rows
        HOLE_ROWS.forEach((row, rowIndex) => {
            const gridRow = rowIndex + 2;
            
            // Row header
            gridHTML += `<div class="grid-row-header" style="grid-row: ${gridRow}; grid-column: 1;">${row}</div>`;
            
            // Row count cell
            gridHTML += `<div class="row-count-cell" style="grid-row: ${gridRow}; grid-column: 2;" id="count-${row}">0</div>`;
            
            // Hole cells
            for (let col = 1; col <= MAX_COLUMNS; col++) {
                const holeId = `${row}-${col}`;
                const holeInfo = holeData[holeId] || {};
                const statusClass = getStatusClass(holeInfo.condition);
                const depth = holeInfo.depth || '';
                
                gridHTML += `
                    <div class="hole-cell" style="grid-row: ${gridRow}; grid-column: ${col + 2};" 
                         data-hole-id="${holeId}" data-row-index="${rowIndex}">
                        <div class="staggered-row-content">
                            <div class="hole-dot ${statusClass}" data-hole-id="${holeId}"onclick="openHoleModal('${holeId}')">
                                ${depth}
                            </div>
                        </div>
                    </div>
                `;
            }
        });

        drillGrid.innerHTML = gridHTML;

        // Add click event listeners to hole dots
        setTimeout(() => {
            const holeDots = document.querySelectorAll('.hole-dot');
            holeDots.forEach(dot => {
                dot.addEventListener('click', function() {
                    const holeId = this.getAttribute('data-hole-id');
                    openHoleModal(holeId);
                });
            });
        }, 100);
    }

    function getStatusClass(condition) {
        if (!condition) return '';
        
        switch(condition.toLowerCase()) {
            case 'kering': return 'status-D';
            case 'basah': return 'status-W';
            case 'collapse': return 'status-C';
            default: return '';
        }
    }

	function openHoleModal(holeId) {
	    console.log('Opening modal for:', holeId);
	    currentHoleId = holeId;
	    const modal = document.getElementById('holeModal');
	    const holeInfo = holeData[holeId] || {};
    
	    document.getElementById('modalHoleId').textContent = `Hole: ${holeId}`;
	    document.getElementById('holeDepth').value = holeInfo.depth || '';
	    document.getElementById('holeCondition').value = holeInfo.condition || '';
    
	    // POSISI FIXED DI TENGAH LAYAR - TIDAK PERLU POSITIONING MANUAL
	    modal.classList.remove('hidden');
	}

	function closeHoleModal() {
	    document.getElementById('holeModal').classList.add('hidden');
	    currentHoleId = null;
	}

    function saveHoleData() {
        if (!currentHoleId) return;
        
        const depth = document.getElementById('holeDepth').value;
        const condition = document.getElementById('holeCondition').value;
        
        if (!depth || !condition) {
            showNotification('Kedalaman dan kondisi harus diisi!', true);
            return;
        }
        
        holeData[currentHoleId] = {
            depth: parseFloat(depth),
            condition: condition
        };
        
        updateHoleDotUI(currentHoleId);
        updateRowCounters();
        saveSessionData();
        
        closeHoleModal();
        showNotification(`Data lubang ${currentHoleId} berhasil disimpan`);
    }

    function updateHoleDotUI(holeId) {
        const holeInfo = holeData[holeId];
        const dot = document.querySelector(`.hole-dot[data-hole-id="${holeId}"]`);
        
        if (dot && holeInfo) {
            dot.className = 'hole-dot ' + getStatusClass(holeInfo.condition);
            dot.textContent = holeInfo.depth;
        } else if (dot) {
            dot.className = 'hole-dot';
            dot.textContent = '';
        }
    }

    function updateRowCounters() {
        HOLE_ROWS.forEach(row => {
            let count = 0;
            for (let col = 1; col <= MAX_COLUMNS; col++) {
                const holeId = `${row}-${col}`;
                if (holeData[holeId] && holeData[holeId].depth) {
                    count++;
                }
            }
            const countElement = document.getElementById(`count-${row}`);
            if (countElement) {
                countElement.textContent = count;
            }
        });
    }

    function clearAllHoles() {
        if (confirm('Apakah Anda yakin ingin menghapus SEMUA data lubang?')) {
            holeData = {};
            generateDrillGrid();
            updateRowCounters();
            saveSessionData();
            showNotification('Semua data lubang berhasil dihapus');
        }
    }

    // FUNGSI IMPORT/EXCEL EXCEL
    function handleExcelImport() {
        const fileInput = document.getElementById('excelImport');
        const file = fileInput.files[0];
        
        if (!file) {
            showNotification('Pilih file Excel terlebih dahulu!', true);
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                importData = [];
                let previewHTML = '<table class="w-full text-xs border-collapse">';
                previewHTML += '<tr><th class="border p-1">ID HOLE</th><th class="border p-1">DEPTH (m)</th><th class="border p-1">CONDITION</th></tr>';
                
                jsonData.forEach((row, index) => {
                    if (index === 0 && row[0] === 'ID HOLE') return;
                    
                    if (row.length >= 3 && row[0] && row[1] && row[2]) {
                        const holeId = String(row[0]).trim().toUpperCase();
                        const depth = parseFloat(row[1]);
                        const condition = String(row[2]).trim();
                        
                        if (isValidHoleId(holeId) && !isNaN(depth) && isValidCondition(condition)) {
                            importData.push({ holeId, depth, condition });
                            
                            previewHTML += `<tr>
                                <td class="border p-1">${holeId}</td>
                                <td class="border p-1">${depth}</td>
                                <td class="border p-1">${condition}</td>
                            </tr>`;
                        }
                    }
                });
                
                previewHTML += '</table>';
                
                if (importData.length > 0) {
                    document.getElementById('importPreviewContent').innerHTML = previewHTML;
                    document.getElementById('importPreview').classList.remove('hidden');
                    showNotification(`Berhasil membaca ${importData.length} data dari Excel`);
                } else {
                    showNotification('Tidak ada data valid yang ditemukan dalam file Excel', true);
                }
                
            } catch (error) {
                console.error('Error reading Excel file:', error);
                showNotification('Error membaca file Excel: ' + error.message, true);
            }
        };
        
        reader.onerror = function() {
            showNotification('Error membaca file', true);
        };
        
        reader.readAsArrayBuffer(file);
    }

    function confirmImport() {
        if (!importData || importData.length === 0) {
            showNotification('Tidak ada data untuk diimport', true);
            return;
        }
        
        if (!confirm(`Import ${importData.length} data? Data existing akan ditimpa.`)) {
            return;
        }
        
        let importedCount = 0;
        importData.forEach(item => {
            holeData[item.holeId] = {
                depth: item.depth,
                condition: item.condition
            };
            importedCount++;
        });
        
        generateDrillGrid();
        updateRowCounters();
        saveSessionData();
        
        document.getElementById('importPreview').classList.add('hidden');
        document.getElementById('excelImport').value = '';
        importData = null;
        
        showNotification(`Berhasil mengimport ${importedCount} data lubang`);
    }

    function isValidHoleId(holeId) {
        const pattern = /^[A-O]-[1-9][0-9]?$/;
        return pattern.test(holeId);
    }

    function isValidCondition(condition) {
        const validConditions = ['kering', 'basah', 'collapse', 'Kering', 'Basah', 'Collapse'];
        return validConditions.includes(condition);
    }

    function exportToExcel() {
        try {
            const exportData = [['ID HOLE', 'DEPTH HOLE (m)', 'HOLE CONDITION']];
            
            HOLE_ROWS.forEach(row => {
                for (let col = 1; col <= MAX_COLUMNS; col++) {
                    const holeId = `${row}-${col}`;
                    const holeInfo = holeData[holeId];
                    if (holeInfo && holeInfo.depth) {
                        exportData.push([holeId, holeInfo.depth, holeInfo.condition]);
                    }
                }
            });
            
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Sounding Data');
            
            const pit = document.getElementById('pit').value || 'Unknown';
            const lokasi = document.getElementById('lokasi').value || 'Unknown';
            const tanggal = document.getElementById('tanggal').value || new Date().toISOString().split('T')[0];
            const filename = `Sounding_${pit}_${lokasi}_${tanggal}.xlsx`;
            
            XLSX.writeFile(wb, filename);
            showNotification(`Data berhasil diexport ke ${filename}`);
            
        } catch (error) {
            console.error('Error exporting to Excel:', error);
            showNotification('Error exporting to Excel: ' + error.message, true);
        }
    }

    function downloadTemplate() {
        const templateData = [
            ['ID HOLE', 'DEPTH HOLE (m)', 'HOLE CONDITION'],
            ['A-1', '12.5', 'Kering'],
            ['A-2', '13.2', 'Basah'],
            ['B-1', '11.8', 'Collapse'],
            ['C-3', '14.1', 'Kering']
        ];
        
        const ws = XLSX.utils.aoa_to_sheet(templateData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Template');
        XLSX.writeFile(wb, 'Sounding_Template.xlsx');
        
        showNotification('Template Excel berhasil didownload');
    }

    // FUNGSI SESSION MANAGEMENT
    function saveSessionData() {
        const sessionData = {
            holeData: holeData,
            formData: {
                pit: document.getElementById('pit').value,
                shift: document.getElementById('shift').value,
                lokasi: document.getElementById('lokasi').value,
                tanggal: document.getElementById('tanggal').value,
                planHole: document.getElementById('planHole').value,
                namaCrew: document.getElementById('namaCrew').value,
                namaGL: document.getElementById('namaGL').value,
                burden: document.getElementById('burden').value,
                spasi: document.getElementById('spasi').value,
                unitDrilling: document.getElementById('unitDrilling').value
            },
            northDirection: currentNorthDirection,
            timestamp: new Date().toISOString()
        };
        
        localStorage.setItem('sounding_session', JSON.stringify(sessionData));
        
        // Simpan tanda tangan secara terpisah
        if (signaturePad && !signaturePad.isEmpty()) {
            localStorage.setItem('sounding_signature', signaturePad.toDataURL());
        }
    }

    function loadSessionData() {
        const saved = localStorage.getItem('sounding_session');
        if (saved) {
            try {
                const sessionData = JSON.parse(saved);
                
                if (sessionData.formData) {
                    Object.keys(sessionData.formData).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = sessionData.formData[key];
                        }
                    });
                }
                
                if (sessionData.holeData) {
                    holeData = { ...sessionData.holeData };
                    generateDrillGrid();
                    updateRowCounters();
                }
                
                if (sessionData.northDirection) {
                    currentNorthDirection = sessionData.northDirection;
                    const compassDirections = document.querySelectorAll('.compass-direction');
                    compassDirections.forEach(dir => {
                        dir.classList.remove('active');
                        if (dir.getAttribute('data-direction') === currentNorthDirection) {
                            dir.classList.add('active');
                        }
                    });
                }
                
                console.log('Session data loaded successfully');
                
            } catch (error) {
                console.error('Error loading session data:', error);
            }
        }
    }

    // FUNGSI PDF YANG SUDAH DIPERBAIKI - DENGAN FONT LEBIH BESAR DAN KOMPAS DINAMIS
    function generatePdf() {
        if (Object.keys(holeData).length === 0) {
            showNotification('Tidak ada data lubang untuk dibuat PDF!', true);
            return;
        }

        showNotification('üîÑ Membuat PDF...');

        // Buat elemen sementara untuk PDF - DENGAN FONT LEBIH BESAR
        const pdfElement = document.createElement('div');
        pdfElement.style.padding = '20px';
        pdfElement.style.backgroundColor = 'white';
        pdfElement.style.width = '1100px';
        pdfElement.style.fontFamily = 'Arial, sans-serif';
        pdfElement.style.fontSize = '14px'; // FONT LEBIH BESAR
        pdfElement.style.color = '#000000';
        pdfElement.style.lineHeight = '1.4';

        // Generate grid untuk PDF DENGAN FONT LEBIH BESAR
        let gridHTML = '<div style="display: grid; grid-template-columns: 40px 40px ' + Array(MAX_COLUMNS).fill('32px').join(' ') + '; gap: 1px; font-size: 12px; margin: 8px 0;">'; // FONT LEBIH BESAR
        
        // Header
        gridHTML += '<div style="font-weight: bold; text-align: center; padding: 4px; background: #f3f4f6; font-size: 11px;"></div>';
        gridHTML += '<div style="font-weight: bold; text-align: center; padding: 4px; background: #f3f4f6; font-size: 11px;">COUNT</div>';
        for (let col = 1; col <= MAX_COLUMNS; col++) {
            gridHTML += `<div style="font-weight: bold; text-align: center; padding: 4px; background: #f3f4f6; font-size: 11px;">${col}</div>`;
        }

        // Data rows
        HOLE_ROWS.forEach((row, rowIndex) => {
            // Row header
            gridHTML += `<div style="font-weight: bold; text-align: center; padding: 4px; background: #e5e7eb; font-size: 12px;">${row}</div>`;
            
            // Row count
            let rowCount = 0;
            for (let col = 1; col <= MAX_COLUMNS; col++) {
                const holeId = `${row}-${col}`;
                if (holeData[holeId] && holeData[holeId].depth) {
                    rowCount++;
                }
            }
            gridHTML += `<div style="font-weight: bold; text-align: center; padding: 4px; background: #fef3c7; font-size: 12px;">${rowCount}</div>`;
            
            // Hole cells dengan staggered pattern DAN FONT LEBIH BESAR
            for (let col = 1; col <= MAX_COLUMNS; col++) {
                const holeId = `${row}-${col}`;
                const holeInfo = holeData[holeId] || {};
                let bgColor = '#f9fafb';
                let borderColor = '#d1d5db';
                let text = '';
                
                if (holeInfo.condition) {
                    switch(holeInfo.condition.toLowerCase()) {
                        case 'kering': 
                            bgColor = '#34d399';
                            borderColor = '#059669';
                            break;
                        case 'basah': 
                            bgColor = '#60a5fa';
                            borderColor = '#2563eb';
                            break;
                        case 'collapse': 
                            bgColor = '#fca5a5';
                            borderColor = '#ef4444';
                            break;
                    }
                    text = holeInfo.depth || '';
                }
                
                const staggered = [1,3,5,7,9,11,13,15].includes(rowIndex) ? 'translateX(6px)' : 'translateX(0)';
                
                gridHTML += `
                    <div style="transform: ${staggered}; display: flex; justify-content: center; align-items: center; height: 32px;">
                        <div style="background: ${bgColor}; border: 2px solid ${borderColor}; color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; font-family: Arial, sans-serif;">
                            ${text}
                        </div>
                    </div>
                `;
            }
        });

        gridHTML += '</div>';

        // KOMPAS DINAMIS BERDASARKAN ARAH YANG DIPILIH
        let compassHTML = '';
        if (currentNorthDirection) {
            let arrowStyle = '';
            
            switch(currentNorthDirection) {
                case '^':
                    arrowStyle = 'top: 10px; left: 50%; transform: translateX(-50%);';
                    break;
                case '>':
                    arrowStyle = 'top: 50%; right: 5px; transform: translateY(-50%) rotate(90deg);';
                    break;
                case 'v':
                    arrowStyle = 'bottom: 5px; left: 50%; transform: translateX(-50%) rotate(180deg);';
                    break;
                case '<':
                    arrowStyle = 'top: 50%; left: 5px; transform: translateY(-50%) rotate(270deg);';
                    break;
            }
            
            compassHTML = `
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <div style="font-weight: bold; margin-bottom: 8px; font-size: 16px;">Arah Utara</div> <!-- FONT LEBIH BESAR -->
                    <div style="width: 80px; height: 80px; border: 2px solid #333; border-radius: 50%; position: relative; background: #f8fafc;">
                        <div style="position: absolute; ${arrowStyle} width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-bottom: 25px solid #f59e0b;"></div>
			<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; background: #333; border-radius: 50%;"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Handle signature - AMAN DARI CROSS-ORIGIN
        let signatureHTML = '<span style="color: #999; font-size: 12px;">Tanda Tangan</span>'; // FONT LEBIH BESAR
        if (signaturePad && !signaturePad.isEmpty()) {
            try {
                const signatureDataUrl = signaturePad.toDataURL();
                signatureHTML = `<img src="${signatureDataUrl}" style="max-height: 70px; max-width: 180px;" />`; // UKURAN LEBIH BESAR
            } catch (error) {
                console.warn('Cannot export signature:', error);
                signatureHTML = '<span style="color: #999; font-size: 12px;">[Tanda Tangan - Tidak dapat diexport]</span>';
            }
        }

        // Isi konten PDF dengan layout baru - FONT LEBIH BESAR
        pdfElement.innerHTML = `
            <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 15px;">
                <h1 style="font-size: 24px; font-weight: bold; margin: 0; color: #1f2937;">PT. KALIMANTAN PRIMA PERSADA - DISTRIK INDE</h1> <!-- FONT LEBIH BESAR -->
                <h2 style="font-size: 18px; font-weight: bold; margin: 5px 0; color: #374151;">PEMERIKSAAN KONDISI & KEDALAMAN LUBANG TEMBAK</h2> <!-- FONT LEBIH BESAR -->
            </div>

            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; font-size: 16px; border: 1px solid #e5e7eb; padding: 10px; border-radius: 6px;"> <!-- FONT LEBIH BESAR -->
                <div><strong>Tanggal:</strong> ${document.getElementById('tanggal').value || '-'}</div>
                <div><strong>Shift:</strong> ${document.getElementById('shift').value || '-'}</div>
                <div><strong>PIT:</strong> ${document.getElementById('pit').value || '-'}</div>
                <div><strong>Lokasi:</strong> ${document.getElementById('lokasi').value || '-'}</div>
                <div><strong>Plan Hole:</strong> ${document.getElementById('planHole').value || '-'}</div>
                <div><strong>B x S:</strong> ${document.getElementById('burden').value || '-'} x ${document.getElementById('spasi').value || '-'}</div>
                <div><strong>Unit:</strong> ${document.getElementById('unitDrilling').value || '-'}</div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 10px; text-align: center;">Visualisasi Kondisi Lubang</h3> <!-- FONT LEBIH BESAR DAN DI TENGAH -->
                ${gridHTML}
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 25px; border-top: 1px solid #ccc; padding-top: 15px;">
                <div style="flex: 1;">
                    <h4 style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">Keterangan Status:</h4> <!-- FONT LEBIH BESAR -->
                    <ul style="font-size: 13px; margin: 0; padding-left: 20px;"> <!-- FONT LEBIH BESAR -->
                        <li style="margin-bottom: 5px;">üü¢ D: KERING</li>
                        <li style="margin-bottom: 5px;">üîµ W: BASAH</li>
                        <li>üî¥ C: COLLAPSE</li>
                    </ul>
                </div>
                
                ${compassHTML}
                
                <div style="flex: 1; text-align: center;">
                    <h4 style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">Tanda Tangan Pemeriksa:</h4> <!-- FONT LEBIH BESAR -->
                    <div style="border: 1px solid #ccc; height: 80px; width: 200px; margin: 0 auto; display: flex; align-items: center; justify-content: center; background: white;">
                        ${signatureHTML}
                    </div>
                    <p style="font-size: 13px; margin-top: 5px; font-weight: bold;">${document.getElementById('namaCrew').value || 'Pemeriksa'}</p> <!-- FONT LEBIH BESAR -->
                </div>
            </div>

            <div style="margin-top: 20px; font-size: 11px; color: #666; text-align: center; border-top: 1px solid #eee; padding-top: 10px;"> <!-- FONT LEBIH BESAR -->
                <p>Dokumen ini dibuat secara digital - PT. Kalimantan Prima Persada - Distrik Inde</p>
                <p>Generated on: ${new Date().toLocaleString('id-ID')}</p>
            </div>
        `;

        // Tambahkan ke body sementara
        document.body.appendChild(pdfElement);

        // Generate PDF dengan html2canvas options yang aman
        html2canvas(pdfElement, {
            scale: 2,
            useCORS: false,
            allowTaint: false,
            logging: false,
            width: 1100,
            height: pdfElement.scrollHeight,
            backgroundColor: '#ffffff',
            onclone: function(clonedDoc) {
                const images = clonedDoc.querySelectorAll('img');
                images.forEach(img => {
                    if (!img.src.startsWith('data:')) {
                        img.style.display = 'none';
                    }
                });
            }
        }).then(canvas => {
            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            const pdf = new jspdf.jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });

            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;
            const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
            const imgX = (pdfWidth - imgWidth * ratio) / 2;
            const imgY = 5;

            pdf.addImage(imgData, 'JPEG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
            
            const pit = document.getElementById('pit').value || 'Unknown';
            const lokasi = document.getElementById('lokasi').value || 'Unknown';
            const tanggal = document.getElementById('tanggal').value || new Date().toISOString().split('T')[0];
            const filename = `Sounding_Report_${pit}_${lokasi}_${tanggal}.pdf`;
            
            pdf.save(filename);

            // Hapus elemen sementara
            document.body.removeChild(pdfElement);
            
            showNotification('‚úÖ PDF berhasil di-generate dan didownload!');
        }).catch(error => {
            console.error('Error generating PDF:', error);
            document.body.removeChild(pdfElement);
            showNotification('‚ùå Gagal membuat PDF: ' + error.message, true);
        });
    }

    // ... (FUNGSI LAINNYA TETAP SAMA) ...

    // FUNGSI LOGIN/LOGOUT
    function showLoginModal() {
        document.getElementById('loginModal').classList.remove('hidden');
    }

    function hideLoginModal() {
        document.getElementById('loginModal').classList.add('hidden');
        document.getElementById('loginForm').reset();
    }

    function handleLogin(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (!username || !password) {
            showNotification('Username dan password harus diisi!', true);
            return;
        }
        
        const user = USERS[username];
        if (user && user.password === password) {
            currentUser = {
                username: username,
                role: user.role,
                name: user.name
            };
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            updateUserInterface();
            hideLoginModal();
            showNotification(`Login berhasil! Selamat datang ${user.name}`);
            
            // Jika admin, sync database
            if (user.role === 'admin') {
                syncDatabase();
            }
        } else {
            showNotification('Username atau password salah!', true);
        }
    }

    function handleLogout() {
        currentUser = null;
        localStorage.removeItem('currentUser');
        updateUserInterface();
        showNotification('Logout berhasil!');
    }

    function updateUserInterface() {
        const userInfoSection = document.getElementById('userInfoSection');
        const loginBtn = document.getElementById('loginBtn');
        
        if (currentUser) {
            userInfoSection.classList.remove('hidden');
            document.getElementById('userRoleDisplay').textContent = 
                currentUser.role === 'admin' ? 'üë®‚Äçüíº ADMIN' : 'üë§ USER';
            document.getElementById('userNameDisplay').textContent = currentUser.name;
            loginBtn.textContent = 'üîê ' + currentUser.name;
            loginBtn.classList.add('bg-green-600', 'hover:bg-green-500');
            loginBtn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
        } else {
            userInfoSection.classList.add('hidden');
            loginBtn.textContent = 'üîê LOGIN';
            loginBtn.classList.remove('bg-green-600', 'hover:bg-green-500');
            loginBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');
        }
    }

    // FUNGSI DATABASE
    function syncDatabase() {
        showNotification('üîÑ Menyinkronisasi database...');
        
        // Simulasi delay sinkronisasi
        setTimeout(() => {
            const allData = getAllStoredData();
            const dbResults = document.getElementById('dbResults');
            
            if (allData.length === 0) {
                dbResults.innerHTML = `
                    <div class="text-center p-8 bg-gray-50 rounded-xl">
                        <div class="text-4xl mb-4">üì≠</div>
                        <h3 class="text-xl font-bold text-gray-700 mb-2">Database Kosong</h3>
                        <p class="text-gray-600">Belum ada data yang disimpan ke database</p>
                    </div>
                `;
                showNotification('Database kosong');
                return;
            }
            
            let dbHTML = `
                <div class="mb-4 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-800">Data Tersimpan (${allData.length} entri)</h3>
                    <button onclick="exportAllData()" class="px-4 py-2 gold-gradient text-white rounded-lg hover:shadow-lg transition text-sm font-semibold">
                        üíæ Export Semua Data
                    </button>
                </div>
            `;
            
            allData.forEach((data, index) => {
                const holeCount = Object.keys(data.holeData || {}).length;
                const date = new Date(data.timestamp).toLocaleDateString('id-ID');
                
                dbHTML += `
                    <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-gray-800">${data.formData?.pit || 'Unknown'} - ${data.formData?.lokasi || 'Unknown'}</h4>
                                <p class="text-sm text-gray-600">${date} - Shift: ${data.formData?.shift || '-'}</p>
                            </div>
                            <span class="bg-amber-100 text-amber-800 text-xs font-semibold px-2 py-1 rounded">
                                ${holeCount} lubang
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 text-xs mb-3">
                            <div><strong>Crew:</strong> ${data.formData?.namaCrew || '-'}</div>
                            <div><strong>GL:</strong> ${data.formData?.namaGL || '-'}</div>
                            <div><strong>B x S:</strong> ${data.formData?.burden || '-'} x ${data.formData?.spasi || '-'}</div>
                            <div><strong>Unit:</strong> ${data.formData?.unitDrilling || '-'}</div>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="loadDatabaseEntry(${index})" class="flex-1 px-3 py-2 bg-blue-600 text-white text-xs font-semibold rounded-lg hover:bg-blue-700 transition">
                                üìÇ Load
                            </button>
                            <button onclick="previewDatabaseEntry(${index})" class="flex-1 px-3 py-2 bg-gray-600 text-white text-xs font-semibold rounded-lg hover:bg-gray-700 transition">
                                üëÅÔ∏è Preview
                            </button>
                            ${currentUser && currentUser.role === 'admin' ? `
                                <button onclick="deleteDatabaseEntry(${index})" class="px-3 py-2 bg-red-600 text-white text-xs font-semibold rounded-lg hover:bg-red-700 transition">
                                    üóëÔ∏è Hapus
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            dbResults.innerHTML = dbHTML;
            showNotification(`‚úÖ Database berhasil disinkronisasi! ${allData.length} entri ditemukan.`);
            
        }, 1500);
    }

    function getAllStoredData() {
        const allData = [];
        
        // Ambil semua key dari localStorage
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            
            if (key.startsWith('sounding_data_')) {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    allData.push({
                        ...data,
                        storageKey: key
                    });
                } catch (error) {
                    console.error('Error parsing data for key:', key, error);
                }
            }
        }
        
        // Urutkan berdasarkan timestamp (terbaru pertama)
        return allData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    }

    function loadDatabaseEntry(index) {
        const allData = getAllStoredData();
        if (index >= 0 && index < allData.length) {
            const data = allData[index];
            
            // Load form data
            if (data.formData) {
                Object.keys(data.formData).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = data.formData[key];
                    }
                });
            }
            
            // Load hole data
            if (data.holeData) {
                holeData = { ...data.holeData };
                generateDrillGrid();
                updateRowCounters();
            }
            
            // Load north direction
            if (data.northDirection) {
                currentNorthDirection = data.northDirection;
                const compassDirections = document.querySelectorAll('.compass-direction');
                compassDirections.forEach(dir => {
                    dir.classList.remove('active');
                    if (dir.getAttribute('data-direction') === currentNorthDirection) {
                        dir.classList.add('active');
                    }
                });
            }
            
            // Switch to e-sounding section
            showSection('e-sounding');
            showNotification('Data berhasil dimuat dari database!');
        }
    }

    function previewDatabaseEntry(index) {
        const allData = getAllStoredData();
        if (index >= 0 && index < allData.length) {
            const data = allData[index];
            
            // Tampilkan preview dalam modal sederhana
            const holeCount = Object.keys(data.holeData || {}).length;
            const date = new Date(data.timestamp).toLocaleString('id-ID');
            
            let previewHTML = `
                <div class="bg-white p-6 rounded-xl max-w-2xl max-h-96 overflow-y-auto">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Preview Data</h3>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><strong>PIT:</strong> ${data.formData?.pit || '-'}</div>
                        <div><strong>Lokasi:</strong> ${data.formData?.lokasi || '-'}</div>
                        <div><strong>Tanggal:</strong> ${data.formData?.tanggal || '-'}</div>
                        <div><strong>Shift:</strong> ${data.formData?.shift || '-'}</div>
                        <div><strong>Crew:</strong> ${data.formData?.namaCrew || '-'}</div>
                        <div><strong>GL:</strong> ${data.formData?.namaGL || '-'}</div>
                        <div><strong>Plan Hole:</strong> ${data.formData?.planHole || '-'}</div>
                        <div><strong>B x S:</strong> ${data.formData?.burden || '-'} x ${data.formData?.spasi || '-'}</div>
                    </div>
                    
                    <div class="mb-4">
                        <strong>Total Lubang:</strong> ${holeCount}
                    </div>
                    
                    <div class="mb-4">
                        <strong>Waktu Simpan:</strong> ${date}
                    </div>
                    
                    <div class="flex justify-end space-x-2">
                        <button onclick="closePreviewModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">
                            Tutup
                        </button>
                        <button onclick="loadDatabaseEntry(${index}); closePreviewModal()" class="px-4 py-2 gold-gradient text-white rounded-lg hover:shadow-lg transition">
                            Load Data
                        </button>
                    </div>
                </div>
            `;
            
            // Buat modal preview
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'previewModal';
            modal.innerHTML = previewHTML;
            
            document.body.appendChild(modal);
            
            // Tambahkan event listener untuk tutup modal
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closePreviewModal();
                }
            });
        }
    }

    function closePreviewModal() {
        const modal = document.getElementById('previewModal');
        if (modal) {
            document.body.removeChild(modal);
        }
    }

    function deleteDatabaseEntry(index) {
        if (!confirm('Apakah Anda yakin ingin menghapus data ini?')) {
            return;
        }
        
        const allData = getAllStoredData();
        if (index >= 0 && index < allData.length) {
            const data = allData[index];
            localStorage.removeItem(data.storageKey);
            showNotification('Data berhasil dihapus dari database!');
            syncDatabase(); // Refresh tampilan
        }
    }

    function clearLocalDatabase() {
        if (!confirm('HAPUS SEMUA DATA LOKAL? Tindakan ini tidak dapat dibatalkan!')) {
            return;
        }
        
        let deletedCount = 0;
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('sounding_data_')) {
                localStorage.removeItem(key);
                deletedCount++;
            }
        }
        
        showNotification(`${deletedCount} data berhasil dihapus dari database lokal!`);
        syncDatabase();
    }

    function exportAllData() {
        try {
            const allData = getAllStoredData();
            if (allData.length === 0) {
                showNotification('Tidak ada data untuk diexport!', true);
                return;
            }
            
            // Format data untuk Excel
            const exportData = [['PIT', 'LOKASI', 'TANGGAL', 'SHIFT', 'CREW', 'GL', 'PLAN_HOLE', 'BURDEN', 'SPASI', 'UNIT', 'HOLE_ID', 'DEPTH', 'CONDITION', 'TIMESTAMP']];
            
            allData.forEach(data => {
                const formData = data.formData || {};
                
                // Export setiap hole secara individual
                if (data.holeData) {
                    Object.entries(data.holeData).forEach(([holeId, holeInfo]) => {
                        exportData.push([
                            formData.pit || '',
                            formData.lokasi || '',
                            formData.tanggal || '',
                            formData.shift || '',
                            formData.namaCrew || '',
                            formData.namaGL || '',
                            formData.planHole || '',
                            formData.burden || '',
                            formData.spasi || '',
                            formData.unitDrilling || '',
                            holeId,
                            holeInfo.depth || '',
                            holeInfo.condition || '',
                            data.timestamp || ''
                        ]);
                    });
                }
            });
            
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'All_Sounding_Data');
            
            const filename = `Sounding_Complete_Database_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showNotification(`‚úÖ Semua data (${allData.length} entri) berhasil diexport!`);
            
        } catch (error) {
            console.error('Error exporting all data:', error);
            showNotification('‚ùå Gagal mengexport data: ' + error.message, true);
        }
    }

    // FUNGSI UTILITAS
    function saveData() {
        saveSessionData();
        showNotification('‚úÖ Data berhasil disimpan sementara!');
    }

    function generateFinalReport() {
        if (Object.keys(holeData).length === 0) {
            showNotification('Tidak ada data lubang untuk disimpan!', true);
            return;
        }
        
        // Simpan ke database
        const timestamp = new Date().toISOString();
        const storageKey = `sounding_data_${timestamp}`;
        
        const dataToSave = {
            holeData: holeData,
            formData: {
                pit: document.getElementById('pit').value,
                shift: document.getElementById('shift').value,
                lokasi: document.getElementById('lokasi').value,
                tanggal: document.getElementById('tanggal').value,
                planHole: document.getElementById('planHole').value,
                namaCrew: document.getElementById('namaCrew').value,
                namaGL: document.getElementById('namaGL').value,
                burden: document.getElementById('burden').value,
                spasi: document.getElementById('spasi').value,
                unitDrilling: document.getElementById('unitDrilling').value
            },
            northDirection: currentNorthDirection,
            timestamp: timestamp,
            user: currentUser ? currentUser.username : 'anonymous'
        };
        
        localStorage.setItem(storageKey, JSON.stringify(dataToSave));
        
        showNotification('üöÄ Data berhasil disimpan ke database!');
        
        // Auto generate PDF
        setTimeout(() => {
            generatePdf();
        }, 1000);
    }

    function clearSignature() {
        if (signaturePad) {
            signaturePad.clear();
            document.getElementById('signaturePlaceholder').style.display = 'block';
            localStorage.removeItem('sounding_signature');
        }
    }

    function showNotification(message, isError = false) {
        // Hapus notifikasi sebelumnya
        const existingNotification = document.querySelector('.custom-notification');
        if (existingNotification) {
            document.body.removeChild(existingNotification);
        }
        
        const notification = document.createElement('div');
        notification.className = `custom-notification fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg font-semibold text-white transform transition-all duration-300 ${
            isError ? 'bg-red-500' : 'bg-green-500'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Animasi masuk
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 10);
        
        // Auto hide setelah 3 detik
        setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    // Inisialisasi user interface saat load
    updateUserInterface();

    function updateUserInterface() {
        const userInfoSection = document.getElementById('userInfoSection');
        const loginBtn = document.getElementById('loginBtn');
        
        if (currentUser) {
            userInfoSection.classList.remove('hidden');
            document.getElementById('userRoleDisplay').textContent = 
                currentUser.role === 'admin' ? 'üë®‚Äçüíº ADMIN' : 'üë§ USER';
            document.getElementById('userNameDisplay').textContent = currentUser.name;
            loginBtn.textContent = 'üîê ' + currentUser.name;
            loginBtn.classList.add('bg-green-600', 'hover:bg-green-500');
            loginBtn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
        } else {
            userInfoSection.classList.add('hidden');
            loginBtn.textContent = 'üîê LOGIN';
            loginBtn.classList.remove('bg-green-600', 'hover:bg-green-500');
            loginBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');
        }
    }

    function updatePreviewData() {
        const currentDataDiv = document.getElementById('currentData');
        const totalHoles = Object.keys(holeData).length;
        const statTotalHoles = document.getElementById('statTotalHoles');
        const statAvgDepth = document.getElementById('statAvgDepth');
        const statDryPercentage = document.getElementById('statDryPercentage');
        
        if (totalHoles === 0) {
            currentDataDiv.innerHTML = `
                <div class="bg-white rounded-xl p-4 shadow border border-gray-200">
                    <div class="text-sm text-gray-600">Isi data di section E-SOUNDING untuk melihat preview</div>
                </div>
            `;
            statTotalHoles.textContent = '0';
            statAvgDepth.textContent = '0.0 m';
            statDryPercentage.textContent = '0%';
            return;
        }
        
        // Hitung statistik
        let totalDepth = 0;
        let dryCount = 0;
        
        Object.values(holeData).forEach(hole => {
            totalDepth += hole.depth || 0;
            if (hole.condition && hole.condition.toLowerCase() === 'kering') {
                dryCount++;
            }
        });
        
        const avgDepth = totalDepth / totalHoles;
        const dryPercentage = ((dryCount / totalHoles) * 100).toFixed(1);
        
        // Update statistics
        statTotalHoles.textContent = totalHoles;
        statAvgDepth.textContent = avgDepth.toFixed(1) + ' m';
        statDryPercentage.textContent = dryPercentage + '%';
        
        // Update current data preview
        let previewHTML = '';
        const recentHoles = Object.entries(holeData).slice(-5); // 5 data terakhir
        
        recentHoles.forEach(([holeId, holeInfo]) => {
            const statusColor = holeInfo.condition === 'Kering' ? 'text-green-600' : 
                              holeInfo.condition === 'Basah' ? 'text-blue-600' : 'text-red-600';
            
            previewHTML += `
                <div class="bg-white rounded-xl p-3 shadow border border-gray-200">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-gray-800">${holeId}</span>
                        <span class="text-sm ${statusColor}">${holeInfo.condition}</span>
                    </div>
                    <div class="text-sm text-gray-600 mt-1">Kedalaman: ${holeInfo.depth} m</div>
                </div>
            `;
        });
        
        if (recentHoles.length === 0) {
            previewHTML = `
                <div class="bg-white rounded-xl p-4 shadow border border-gray-200">
                    <div class="text-sm text-gray-600">Tidak ada data lubang</div>
                </div>
            `;
        }
        
        currentDataDiv.innerHTML = previewHTML;
    }

    console.log('E-Sounding System initialized successfully!');
</script>
</body>
</html>

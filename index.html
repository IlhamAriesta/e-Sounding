<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-SOUNDING SYSTEM - PT. KALIMANTAN PRIMA PERSADA</title>
    <!-- Muat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Muat SignaturePad -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <!-- Muat jsPDF dan html2canvas untuk Ekspor PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Muat SheetJS untuk Export Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        .container-card {
            max-width: 1400px;
            margin: 1rem auto;
            padding: 1.5rem;
            background: white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
        }
        .header-box {
            background: linear-gradient(135deg, #374151 0%, #6b7280 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 15px -3px rgba(55, 65, 81, 0.3);
        }
        .gold-gradient {
            background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
        }
        .form-label {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
            display: block;
            font-size: 0.9rem;
        }
        .input-field {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            width: 100%;
            transition: all 0.3s ease;
            background: white;
        }
        .input-field:focus {
            border-color: #f59e0b;
            outline: none;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        /* --- STAGGERED GRID STYLES --- */
        .drill-grid-area {
            display: grid;
            grid-template-columns: 60px repeat(30, minmax(25px, 1fr)); 
            border-top: 1px solid #e5e7eb;
            overflow-x: auto;
            min-width: 100%;
            background-color: white;
            font-size: 0.55rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .grid-header-cell {
            padding: 0.4rem 0.2rem;
            text-align: center;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            font-weight: 600;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
        }
        .grid-header-cell:first-child {
            position: sticky;
            left: 0;
            z-index: 20;
            background: linear-gradient(135deg, #e2e8f0 0%, #f1f5f9 100%);
        }

        .grid-row-header {
            padding: 0.4rem 0.2rem;
            text-align: center;
            font-weight: 700;
            background: linear-gradient(135deg, #e2e8f0 0%, #f1f5f9 100%);
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            position: sticky;
            left: 0;
            z-index: 20;
            font-size: 0.65rem;
        }

        .row-count-cell {
            padding: 0.4rem 0.2rem;
            text-align: center;
            font-weight: 600;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            position: sticky;
            left: 50px;
            z-index: 15;
            font-size: 0.6rem;
            color: #92400e;
        }

        .hole-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2px 0;
            height: 45px;
            border-bottom: 1px solid #f3f4f6;
            position: relative;
            transition: background-color 0.2s ease;
        }

        .hole-cell:hover {
            background-color: #f8fafc;
        }

        .staggered-row-content {
            display: flex;
            flex-direction: column;
            width: 100%;
            align-items: center;
            justify-content: center;
        }

        [data-row-index="1"] .staggered-row-content,
        [data-row-index="3"] .staggered-row-content,
        [data-row-index="5"] .staggered-row-content,
        [data-row-index="7"] .staggered-row-content,
        [data-row-index="9"] .staggered-row-content,
        [data-row-index="11"] .staggered-row-content,
        [data-row-index="13"] .staggered-row-content,
        [data-row-index="15"] .staggered-row-content {
            transform: translateX(12px);
        }
        
        .hole-dot {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.55rem;
            line-height: 1;
            width: 22px;
            height: 22px;
            font-weight: 700;
            cursor: pointer;
        }
        .hole-dot:hover {
            transform: scale(1.3);
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        }
        
        .hole-dot.status-D { 
            background: linear-gradient(135deg, #34d399 0%, #059669 100%);
            border: 2px solid #059669;
        }
        .hole-dot.status-W { 
            background: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%);
            border: 2px solid #2563eb;
        }
        .hole-dot.status-C { 
            background: linear-gradient(135deg, #fca5a5 0%, #ef4444 100%);
            border: 2px solid #ef4444;
        }
        
        .hole-modal {
            position: fixed;
            z-index: 100;
            background: white;
            border: 1px solid #ccc;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2);
            padding: 1.5rem;
            width: 280px;
            animation: modalAppear 0.3s ease-out;
        }

        @keyframes modalAppear {
            from { opacity: 0; transform: scale(0.9) translateY(-10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Perbaikan Signature Pad Styles */
        .signature-container {
            position: relative;
            width: 100%;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        #signatureCanvas {
            width: 100% !important;
            height: 150px !important;
            display: block;
            cursor: crosshair;
            background: white;
            touch-action: none;
            border: 1px solid #e5e7eb;
        }

        .signature-clear-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            z-index: 10;
        }

        .signature-clear-btn:hover {
            background: rgba(220, 38, 38, 0.9);
        }

        .signature-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #9ca3af;
            font-style: italic;
            pointer-events: none;
            z-index: 1;
        }

        #pdfCaptureArea {
            background-color: white;
            padding: 12px;
            width: 100%;
            max-width: 100%;
            overflow: hidden;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        /* PDF-specific styles */
        .pdf-optimized {
            width: 100% !important;
            max-width: 100% !important;
            overflow: hidden !important;
        }
        
        .pdf-drill-grid {
            grid-template-columns: 50px 40px repeat(30, minmax(15px, 1fr)) !important;
            font-size: 0.4rem !important;
        }
        
        /* PERBAIKAN: Font depth hole diperbesar */
        .pdf-hole-dot {
            width: 22px !important;
            height: 22px !important;
            font-size: 0.7rem !important;
            font-weight: 700 !important;
        }

        .pdf-hole-dot span {
            font-size: 0.7rem !important;
            font-weight: 700 !important;
        }

        .pdf-grid-header-cell {
            padding: 0.2rem 0.1rem !important;
            font-size: 0.4rem !important;
        }
        
        .pdf-grid-row-header {
            padding: 0.2rem 0.1rem !important;
            font-size: 0.45rem !important;
        }

        .pdf-row-count-cell {
            padding: 0.2rem 0.1rem !important;
            font-size: 0.4rem !important;
        }

        /* Optimasi tambahan untuk PDF */
        .pdf-optimized #pdfCaptureArea {
            padding: 15px !important;
            width: 1200px !important;
            max-width: 1200px !important;
        }

        .pdf-optimized .text-lg {
            font-size: 1.3rem !important;
        }

        .pdf-optimized .text-md {
            font-size: 1.1rem !important;
        }

        .pdf-optimized .text-sm {
            font-size: 1rem !important;
        }

        .pdf-optimized .text-xs {
            font-size: 0.9rem !important;
        }

        .share-link-container {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid #cbd5e1;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        /* Kompas Arah Mata Angin Styles */
        .compass-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            border: 1px solid #cbd5e1;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .compass-title {
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #1e293b;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .compass-wrapper {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }
        
        .compass-base {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border: 2px solid #9ca3af;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .compass-center {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-radius: 50%;
            z-index: 10;
        }
        
        .compass-axis {
            position: absolute;
            background-color: #6b7280;
            border-radius: 2px;
        }
        
        .compass-axis-horizontal {
            width: 160px;
            height: 4px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .compass-axis-vertical {
            width: 4px;
            height: 160px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .compass-direction {
            position: absolute;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            color: #6b7280;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 5;
            font-size: 0;
        }
        
        .compass-direction:hover {
            transform: scale(1.1);
            background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
        }
        
        .compass-direction.active {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.5);
            font-size: 1rem;
        }
        
        .compass-direction.active::after {
            content: "U";
        }
        
        .compass-direction.north {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .compass-direction.east {
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
        }
        
        .compass-direction.south {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .compass-direction.west {
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
        }

        /* Navigation Styles */
        .nav-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            font-weight: 600;
        }

        .nav-btn.active {
            border-color: #d97706;
            box-shadow: 0 10px 15px -3px rgba(217, 119, 6, 0.3);
            background: white !important;
            color: #92400e !important;
        }

        .content-section {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Premium card effects */
        .premium-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-radius: 12px;
            cursor: pointer;
        }

        .premium-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
        }

        /* Import/Export Section */
        .import-export-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid #cbd5e1;
            border-radius: 12px;
        }

        /* Database Styles */
        .database-grid {
            display: grid;
            grid-template-columns: 60px 50px repeat(30, minmax(25px, 1fr));
            border-top: 1px solid #e5e7eb;
            overflow-x: auto;
            min-width: 100%;
            background-color: white;
            font-size: 0.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .database-grid .hole-dot {
            width: 20px;
            height: 20px;
            font-size: 0.45rem;
        }

        /* Hide elements for PDF */
        .screen-only {
            display: block;
        }
        
        .pdf-only {
            display: none;
        }
        
        @media print {
            .screen-only {
                display: none !important;
            }
            .pdf-only {
                display: block !important;
            }
        }

        /* Tombol Generate */
        .generate-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.4);
        }

        .generate-btn:disabled {
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Login Modal Styles */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
        }

        .user-info {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        /* Kompas untuk PDF */
        .pdf-compass-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 8px;
            border: 1px solid #cbd5e1;
        }
        
        .pdf-compass-wrapper {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }
        
        .pdf-compass-base {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border: 2px solid #9ca3af;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pdf-compass-center {
            width: 15px;
            height: 15px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-radius: 50%;
            z-index: 10;
        }
        
        .pdf-compass-axis {
            position: absolute;
            background-color: #6b7280;
            border-radius: 2px;
        }
        
        .pdf-compass-axis-horizontal {
            width: 100px;
            height: 3px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .pdf-compass-axis-vertical {
            width: 3px;
            height: 100px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .pdf-compass-direction {
            position: absolute;
            width: 25px;
            height: 25px;
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            color: #6b7280;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.7rem;
            z-index: 5;
        }
        
        .pdf-compass-direction.active {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .pdf-compass-direction.north {
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .pdf-compass-direction.east {
            top: 50%;
            right: 5px;
            transform: translateY(-50%);
        }
        
        .pdf-compass-direction.south {
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .pdf-compass-direction.west {
            top: 50%;
            left: 5px;
            transform: translateY(-50%);
        }
    </style>
</head>
<body>

    <!-- PREMIUM HEADER WITH NAVIGATION -->
    <header class="bg-gradient-to-r from-gray-800 to-gray-600 text-white shadow-2xl mb-6 rounded-2xl overflow-hidden mx-4 mt-4">
        <div class="container mx-auto px-6 py-4">
            <!-- Main Header -->
            <div class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold mb-2 tracking-tight">
                    <span class="bg-clip-text text-transparent bg-gradient-to-r from-gray-200 to-gray-100">
                        PT. KALIMANTAN PRIMA PERSADA
                    </span>
                </h1>
                <h2 class="text-xl md:text-2xl font-semibold text-gray-100">DISTRIK INDE - E-SOUNDING SYSTEM</h2>
                <p class="text-gray-200 mt-2 text-sm">Digital Blast Hole Monitoring & Reporting</p>
            </div>

            <!-- Navigation Menu -->
            <nav class="flex flex-wrap justify-center gap-3 mb-2" id="mainNavigation">
                <button data-section="home" class="nav-btn active px-5 py-3 bg-white text-gray-800 font-semibold rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
                    üè† HOME
                </button>
                <button data-section="e-sounding" class="nav-btn px-5 py-3 bg-gray-700 text-white font-semibold rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 hover:bg-gray-600">
                    üìä E-SOUNDING
                </button>
                <button data-section="preview" class="nav-btn px-5 py-3 bg-gray-700 text-white font-semibold rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 hover:bg-gray-600">
                    üëÅÔ∏è PREVIEW
                </button>
                <button data-section="database" class="nav-btn px-5 py-3 bg-gray-700 text-white font-semibold rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 hover:bg-gray-600">
                    üíæ DATABASE
                </button>
                <button id="loginBtn" class="px-5 py-3 bg-blue-600 text-white font-semibold rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 hover:bg-blue-500">
                    üîê LOGIN
                </button>
            </nav>
        </div>
    </header>

    <!-- Login Modal -->
    <div id="loginModal" class="login-modal hidden">
        <div class="login-container">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Login Sistem</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" id="username" class="input-field" placeholder="Masukkan username">
                </div>
                <div class="mb-6">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" id="password" class="input-field" placeholder="Masukkan password">
                </div>
                <div class="flex justify-between">
                    <button type="button" id="cancelLoginBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">
                        Batal
                    </button>
                    <button type="submit" class="px-4 py-2 gold-gradient text-white rounded-lg hover:shadow-lg transition">
                        Login
                    </button>
                </div>
            </form>
            <div class="mt-4 text-sm text-gray-600">
                <p class="font-semibold">Akun Demo:</p>
                <p>Admin: admin / admin123</p>
                <p>User: user / user123</p>
            </div>
        </div>
    </div>

    <div class="container-card">

        <!-- HOME SECTION -->
        <div id="homeSection" class="content-section">
            <div class="text-center py-8">
                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-3xl p-8 shadow-2xl border border-gray-200">
                    <h1 class="text-4xl font-bold text-gray-900 mb-6">üöÄ WELCOME TO E-SOUNDING SYSTEM</h1>
                    <p class="text-xl text-gray-700 mb-8">Digital Solution for Blast Hole Monitoring & Reporting</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="premium-card p-6" onclick="showSection('e-sounding')">
                            <div class="text-4xl mb-4">üìä</div>
                            <h3 class="font-bold text-gray-800 mb-3 text-lg">E-SOUNDING</h3>
                            <p class="text-sm text-gray-600">Input data sounding dengan visualisasi grid interaktif dan import dari Excel</p>
                            <div class="mt-3 text-amber-600 font-semibold">Klik untuk mulai ‚Üí</div>
                        </div>
                        <div class="premium-card p-6" onclick="showSection('preview')">
                            <div class="text-4xl mb-4">üëÅÔ∏è</div>
                            <h3 class="font-bold text-gray-800 mb-3 text-lg">PREVIEW</h3>
                            <p class="text-sm text-gray-600">Lihat hasil visualisasi dan data historis dengan statistik lengkap</p>
                            <div class="mt-3 text-amber-600 font-semibold">Klik untuk melihat ‚Üí</div>
                        </div>
                        <div class="premium-card p-6 gold-gradient text-white" onclick="showSection('database')">
                            <div class="text-4xl mb-4">üíæ</div>
                            <h3 class="font-bold mb-3 text-lg">DATABASE</h3>
                            <p class="text-sm text-amber-100">Lihat dan kelola semua data sounding yang pernah diinput</p>
                            <div class="mt-3 text-amber-200 font-semibold">Klik untuk mengelola ‚Üí</div>
                        </div>
                    </div>
                    
                    <button data-section="e-sounding" class="nav-section-btn px-8 py-4 gold-gradient text-white font-bold rounded-2xl shadow-2xl hover:shadow-3xl transition-all duration-300 transform hover:scale-105 text-lg">
                        üöÄ START E-SOUNDING
                    </button>
                </div>
            </div>
        </div>

        <!-- E-SOUNDING SECTION -->
        <div id="e-soundingSection" class="content-section hidden">
            <!-- Section Informasi Umum dengan SHIFT -->
            <div id="generalInfoInputs" class="grid grid-cols-1 md:grid-cols-5 gap-4 p-6 mb-6 border border-gray-200 rounded-xl bg-gray-50">
                <div><label for="tanggal" class="form-label">Tanggal</label><input type="date" id="tanggal" class="input-field"></div>
                <div>
                    <label for="shift" class="form-label">SHIFT</label>
                    <select id="shift" class="input-field">
                        <option value="">Pilih Shift</option>
                        <option value="SHIFT 1">SHIFT 1</option>
                        <option value="SHIFT 2">SHIFT 2</option>
                    </select>
                </div>
                <div>
                    <label for="pit" class="form-label">PIT</label>
                    <select id="pit" class="input-field">
                        <option value="Tempudo 2">Tempudo 2</option>
                        <option value="Tempudo 3">Tempudo 3</option>
                        <option value="Tempudo 4">Tempudo 4</option>
                    </select>
                </div>
                <div><label for="lokasi" class="form-label">Lokasi</label><input type="text" id="lokasi" class="input-field" placeholder="Lokasi Blok"></div>
                <div><label for="planHole" class="form-label">Plan Hole</label><input type="number" id="planHole" class="input-field" placeholder="Jumlah Plan"></div>
                <div><label for="namaCrew" class="form-label">Nama Crew</label><input type="text" id="namaCrew" class="input-field" placeholder="Nama Crew"></div>
                <div><label for="namaGL" class="form-label">Nama GL</label><input type="text" id="namaGL" class="input-field" placeholder="Nama Group Leader"></div>
                <div><label for="burden" class="form-label">Burden (m)</label><input type="number" step="0.1" id="burden" class="input-field" placeholder="B"></div>
                <div><label for="spasi" class="form-label">Spasi (m)</label><input type="number" step="0.1" id="spasi" class="input-field" placeholder="S"></div>
                <div><label for="unitDrilling" class="form-label">Unit Drilling</label><input type="text" id="unitDrilling" class="input-field" placeholder="Unit"></div>
            </div>

            <!-- Arah Mata Angin dengan Kompas - DIREVISI -->
            <div class="compass-container">
                <div class="compass-title">Pilih Arah Utara dengan mengklik salah satu arah pada kompas:</div>
                
                <div class="compass-wrapper">
                    <!-- Garis horizontal -->
                    <div class="compass-axis compass-axis-horizontal"></div>
                    <!-- Garis vertikal -->
                    <div class="compass-axis compass-axis-vertical"></div>
                    
                    <!-- Lingkaran tengah -->
                    <div class="compass-base">
                        <div class="compass-center"></div>
                    </div>
                    
                    <!-- Arah-arah mata angin (kosong, akan muncul U saat dipilih) -->
                    <div class="compass-direction north" data-direction="utara"></div>
                    <div class="compass-direction east" data-direction="timur"></div>
                    <div class="compass-direction south" data-direction="selatan"></div>
                    <div class="compass-direction west" data-direction="barat"></div>
                </div>
                
                <!-- KETERANGAN ARAH UTARA DIHAPUS -->
            </div>

            <!-- IMPORT/EXPORT SECTION -->
            <div class="import-export-section p-6 mb-6">
                <h3 class="text-xl font-bold mb-4 text-gray-800 text-center">üìä IMPORT/EXPORT DATA</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- IMPORT EXCEL -->
                    <div class="border border-amber-300 rounded-xl p-5 bg-amber-50">
                        <h4 class="font-bold mb-3 text-amber-800 text-lg">üì• IMPORT FROM EXCEL</h4>
                        <p class="text-sm text-gray-600 mb-4">Format: ID HOLE, DEPTH HOLE (m), HOLE CONDITION</p>
                        
                        <!-- TAMBAHAN: Tombol Hapus Semua Lubang -->
                        <div class="mb-4">
                            <button id="clearAllHolesBtn" class="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition flex items-center justify-center font-semibold mb-2">
                                üóëÔ∏è HAPUS SEMUA DATA LUBANG
                            </button>
                            <p class="text-xs text-red-600 text-center">Klik untuk menghapus semua data lubang sebelum import</p>
                        </div>
                        
                        <input type="file" id="excelImport" accept=".xlsx,.xls" 
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-amber-50 file:text-amber-700 hover:file:bg-amber-100 mb-4" />
                        
                        <button id="importExcelBtn" class="w-full px-4 py-3 gold-gradient text-white rounded-lg hover:shadow-lg transition flex items-center justify-center font-semibold">
                            <span>üöÄ IMPORT & AUTO-FILL GRID</span>
                        </button>
                        
                        <div id="importPreview" class="mt-4 hidden">
                            <div class="text-sm font-semibold text-amber-700 mb-2">Preview Import:</div>
                            <div id="importPreviewContent" class="text-xs bg-white p-3 border rounded-lg mt-1 max-h-24 overflow-y-auto"></div>
                            <button id="confirmImportBtn" class="mt-3 w-full px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition font-semibold">
                                ‚úÖ Konfirmasi Import Data
                            </button>
                        </div>
                    </div>

                    <!-- EXPORT EXCEL -->
                    <div class="border border-gray-300 rounded-xl p-5 bg-gray-50">
                        <h4 class="font-bold mb-3 text-gray-800 text-lg">üì§ EXPORT TO EXCEL</h4>
                        <p class="text-sm text-gray-600 mb-4">Download template atau export data existing</p>
                        
                        <div class="grid grid-cols-1 gap-3">
                            <button id="downloadTemplateBtn" class="w-full px-4 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition font-semibold">
                                üìã Download Template Excel
                            </button>
                            <button id="exportExcelBtn" class="w-full px-4 py-3 gold-gradient text-white rounded-lg hover:shadow-lg transition font-semibold">
                                üíæ Export Data ke Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Share Link Section -->
            <div id="shareLinkContainer" class="share-link-container hidden">
                <h3 class="font-bold text-lg mb-2 text-gray-800">üîó Link untuk Melanjutkan Pekerjaan</h3>
                <p class="text-sm text-gray-600 mb-2">Simpan link ini untuk melanjutkan pekerjaan di shift berikutnya:</p>
                <div class="flex gap-2">
                    <input type="text" id="shareableLink" class="input-field flex-1" readonly>
                    <button id="copyShareLinkBtn" class="px-4 py-2 gold-gradient text-white rounded-lg hover:shadow-lg transition">
                        Salin Link
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">Link ini akan menyimpan semua data yang sudah diinput</p>
            </div>

            <!-- Notifikasi & User ID -->
            <div id="notification" class="hidden p-3 mb-4 rounded-lg text-sm" role="alert"></div>
            <div class="mb-4 text-sm text-gray-600">
                User ID (untuk sinkronisasi): <span id="userIdDisplay" class="font-mono bg-gray-100 p-1 rounded">...</span>
                <button id="generateShareLinkBtn" class="ml-4 px-3 py-1 gold-gradient text-white text-sm rounded hover:shadow-lg transition">
                    üîó Buat Link Share
                </button>
            </div>

            <!-- Container Khusus untuk Konten yang akan Di-Capture ke PDF -->
            <div id="pdfCaptureArea" class="bg-white pdf-optimized">

                <!-- Title yang muncul di PDF -->
                 <div class="text-center mb-4">
                    <h1 class="text-lg font-bold mb-1 text-gray-800">PT. KALIMANTAN PRIMA PERSADA - DISTRIK INDE</h1>
                    <h2 class="text-md font-semibold text-gray-700">PEMERIKSAAN KONDISI & KEDALAMAN LUBANG TEMBAK</h2>
                </div>

                <!-- Ringkasan Data Umum (Untuk PDF) -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-1 mb-3 text-xs p-2 border border-gray-300 rounded-lg">
                    <div><span class="font-semibold">Tanggal:</span> <span id="report_tanggal" class="font-medium"></span></div>
                    <div><span class="font-semibold">Shift:</span> <span id="report_shift" class="font-medium"></span></div>
                    <div><span class="font-semibold">PIT:</span> <span id="report_pit" class="font-medium"></span></div>
                    <div><span class="font-semibold">Lokasi:</span> <span id="report_lokasi" class="font-medium"></span></div>
                    <div><span class="font-semibold">Plan Hole:</span> <span id="report_planHole" class="font-medium"></span></div>
                    <div><span class="font-semibold">B x S:</span> <span id="report_geometri" class="font-medium"></span></div>
                    <div><span class="font-semibold">Unit:</span> <span id="report_unit" class="font-medium"></span></div>
                    <div><span class="font-semibold">Arah Utara:</span> <span id="report_north_direction" class="font-medium"></span></div>
                </div>

                <!-- Kompas untuk PDF - DIPERBAIKI -->
                <div id="pdfCompassContainer" class="pdf-compass-container">
                    <div class="text-xs font-semibold mb-1">Diagram Arah Utara:</div>
                    <div class="pdf-compass-wrapper">
                        <div class="pdf-compass-axis pdf-compass-axis-horizontal"></div>
                        <div class="pdf-compass-axis pdf-compass-axis-vertical"></div>
                        <div class="pdf-compass-base">
                            <div class="pdf-compass-center"></div>
                        </div>
                        <div class="pdf-compass-direction north" id="pdfNorth"></div>
                        <div class="pdf-compass-direction east" id="pdfEast"></div>
                        <div class="pdf-compass-direction south" id="pdfSouth"></div>
                        <div class="pdf-compass-direction west" id="pdfWest"></div>
                    </div>
                </div>

                <!-- Section Grid Pemeriksaan Lubang -->
                <div class="overflow-x-auto mb-6">
                    <h3 class="text-md font-bold mb-1 text-gray-700">Visualisasi Kondisi Lubang (Staggered Pattern)</h3>
                    <div id="drillGrid" class="drill-grid-area bg-white rounded-lg border border-gray-300 pdf-drill-grid">
                        <!-- Grid akan di-generate di sini oleh JavaScript -->
                    </div>
                </div>

                <!-- Section Keterangan Ringkas & TTD - FIXED untuk PDF -->
                <div class="mt-6 flex justify-between gap-4 border-t pt-3">
                    
                    <!-- Keterangan Status -->
                    <div class="w-1/3">
                        <h4 class="font-semibold mb-1 text-gray-700 text-sm">Keterangan Status:</h4>
                        <ul class="text-xs space-y-1">
                            <li class="flex items-center"><span class="hole-dot w-3 h-3 rounded-full status-D mr-2"></span> D: KERING (Ideal)</li>
                            <li class="flex items-center"><span class="hole-dot w-3 h-3 rounded-full status-W mr-2"></span> W: BASAH (Ada Air)</li>
                            <li class="flex items-center"><span class="hole-dot w-3 h-3 rounded-full status-C mr-2"></span> C: COLLAPSE</li> 
                        </ul>
                    </div>

                    <!-- Tanda Tangan Area - FIXED untuk PDF -->
                    <div class="w-1/3 text-center">
                        <h3 class="font-semibold mb-1 text-gray-700 text-sm">Tanda Tangan Pemeriksa:</h3>
                        <div class="w-full max-w-[120px] h-16 mx-auto border border-gray-400 bg-gray-100 flex items-center justify-center">
                            <img id="report_signature_img" class="max-w-full max-h-full" alt="Tanda Tangan Pemeriksa">
                        </div>
                        <p class="mt-1 text-xs font-medium" id="report_crew_name">(Nama Crew)</p>
                    </div>

                    <!-- Additional Info untuk PDF -->
                    <div class="w-1/3 text-center pdf-only">
                        <h3 class="font-semibold mb-1 text-gray-700 text-sm">Informasi Tambahan:</h3>
                        <div class="text-xs text-gray-600 space-y-1">
                            <p>Dokumen ini dibuat secara digital</p>
                            <p>PT. Kalimantan Prima Persada</p>
                            <p>Distrik Inde</p>
                        </div>
                    </div>
                </div>

                <!-- Ringkasan Data Copas (Hanya untuk screen, tidak untuk PDF) -->
                <div class="screen-only">
                    <h3 class="text-sm font-bold my-2 text-gray-800 border-t pt-3">Ringkasan Data untuk Mining Dispatch:</h3>
                    <pre id="report_summary_text" class="whitespace-pre-wrap p-2 bg-gray-100 border rounded text-xs font-mono"></pre>
                </div>

            </div> 
            <!-- END pdfCaptureArea -->


            <!-- Modal Pop-up untuk Input Lubang - DIPERBAIKI POSISI -->
            <div id="holeModal" class="hole-modal hidden">
                <h4 class="font-bold mb-3 text-lg text-gray-800" id="modalHoleId">Hole: A-1</h4>
                
                <div class="mb-4">
                    <label for="holeDepth" class="form-label text-sm">Kedalaman (m):</label>
                    <input type="number" step="0.1" id="holeDepth" class="input-field" placeholder="0.0">
                </div>

                <div class="mb-4">
                    <label for="holeCondition" class="form-label text-sm">Kondisi Lubang:</label>
                    <select id="holeCondition" class="input-field">
                        <option value="">Pilih Kondisi</option>
                        <option value="Kering">Kering</option>
                        <option value="Basah">Basah</option>
                        <option value="Collapse">Collapse</option>
                    </select>
                </div>

                <div class="flex space-x-2">
                    <button id="saveHoleDataBtn" class="flex-1 px-3 py-2 gold-gradient text-white text-sm font-semibold rounded-lg hover:shadow-lg transition duration-200">
                        Simpan
                    </button>
                    <button id="closeHoleModalBtn" class="flex-1 px-3 py-2 bg-gray-300 text-gray-800 text-sm font-semibold rounded-lg hover:bg-gray-400 transition duration-200">
                        Batal
                    </button>
                </div>
            </div>

            <!-- Section Tanda Tangan (Screen Only) - IMPROVED -->
            <div class="mt-8 border-t pt-6">
                <h3 class="text-lg font-bold mb-4 text-gray-700">Tanda Tangan (TTD) - Pemeriksa</h3>
                
                <div class="signature-container">
                    <canvas id="signatureCanvas"></canvas>
                    <div class="signature-placeholder" id="signaturePlaceholder">
                        Gambar tanda tangan di area ini menggunakan mouse/touch...
                    </div>
                    <button class="signature-clear-btn" id="clearSignatureBtnSmall">
                        Hapus
                    </button>
                </div>
                
                <div class="flex space-x-4 mt-4">
                    <button id="clearSignatureBtn" class="flex-1 px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-200">
                        Hapus TTD
                    </button>
                    <button id="saveDataBtn" class="flex-1 px-4 py-2 gold-gradient text-white font-semibold rounded-lg hover:shadow-lg transition duration-200">
                        Simpan Data
                    </button>
                </div>
            </div>

            <!-- Section for Report Generation and Copying (Screen Only) -->
            <div class="mt-8 pt-6 border-t">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <button id="generatePdfBtn" class="w-full px-4 py-3 gold-gradient text-white font-bold rounded-lg hover:shadow-lg transition duration-200 shadow-md">
                        üìÑ DOWNLOAD PDF (LANDSCAPE)
                    </button>
                    <button id="exportExcelBtn2" class="w-full px-4 py-3 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-700 transition duration-200 shadow-md">
                        üìä EXPORT EXCEL
                    </button>
                    <button id="generateFinalReportBtn" class="w-full px-4 py-3 generate-btn transition duration-200 shadow-md">
                        üöÄ GENERATE & SIMPAN KE DATABASE
                    </button>
                </div>

                <!-- Database Sync Section -->
                <div class="mt-6 p-4 bg-blue-50 border border-blue-300 rounded-lg">
                    <h4 class="font-bold text-lg mb-2 text-gray-800">üîÑ Sinkronisasi Database</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button id="syncDatabaseBtn" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold">
                            üîÑ Sync dengan Database Server
                        </button>
                        <button id="exportDatabaseBtn" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">
                            üíæ Export Database ke File
                        </button>
                    </div>
                    <div id="syncStatus" class="mt-2 text-sm text-gray-600"></div>
                </div>

                <!-- Copy Paste Output -->
                <div id="copyOutputContainer" class="hidden mt-6 p-4 bg-amber-50 border border-amber-300 rounded-lg">
                    <h4 class="font-bold text-lg mb-2 text-gray-800">Format Data untuk Salin (Copas)</h4>
                    <textarea id="copyOutputText" class="w-full h-40 font-mono text-sm p-2 border rounded resize-none bg-white" readonly></textarea>
                    <button id="copyToClipboardBtn" class="mt-2 px-3 py-1 gold-gradient text-white text-sm rounded hover:shadow-lg transition">
                        Salin ke Clipboard
                    </button>
                    <p class="text-xs text-amber-600 mt-2">Gunakan teks ini untuk Mining Dispatch atau grup WA.</p>
                </div>
            </div>
        </div>

        <!-- PREVIEW SECTION -->
        <div id="previewSection" class="content-section hidden">
            <div class="bg-white rounded-2xl p-8 shadow-2xl border border-gray-200">
                <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">üëÅÔ∏è DATA PREVIEW</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Recent Reports -->
                    <div class="bg-gray-50 rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üìã Data Saat Ini</h3>
                        <div id="currentData" class="space-y-3">
                            <div class="bg-white rounded-xl p-4 shadow border border-gray-200">
                                <div class="text-sm text-gray-600">Isi data di section E-SOUNDING untuk melihat preview</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Statistics -->
                    <div class="bg-amber-50 rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-amber-800 mb-4">üìà Statistik</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Total Lubang:</span>
                                <span class="font-bold text-gray-700" id="statTotalHoles">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Rata-rata Kedalaman:</span>
                                <span class="font-bold text-amber-700" id="statAvgDepth">0.0 m</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Kondisi Kering:</span>
                                <span class="font-bold text-green-700" id="statDryPercentage">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DATABASE SECTION -->
        <div id="databaseSection" class="content-section hidden">
            <div class="bg-white rounded-2xl p-8 shadow-2xl border border-gray-200">
                <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">üíæ DATABASE</h2>
                
                <!-- Database Sync Controls -->
                <div class="mb-6 p-4 bg-blue-50 border border-blue-300 rounded-lg">
                    <h3 class="text-xl font-bold mb-4 text-gray-800 text-center">üîÑ Sinkronisasi Database</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button id="syncDatabaseBtn2" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold">
                            üîÑ Sync dengan Server
                        </button>
                        <button id="importDatabaseFileBtn" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">
                            üì• Import Database File
                        </button>
                        <button id="clearLocalDatabaseBtn" class="w-full px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold">
                            üóëÔ∏è Hapus Database Lokal
                        </button>
                    </div>
                    <div id="databaseSyncStatus" class="mt-2 text-sm text-gray-600 text-center"></div>
                </div>

                <!-- User Info & Logout -->
                <div id="userInfoSection" class="user-info hidden">
                    <div>
                        <span id="userRoleDisplay" class="font-semibold"></span>
                        <span id="userNameDisplay" class="text-gray-600 ml-2"></span>
                    </div>
                    <button id="logoutBtn" class="logout-btn">
                        Logout
                    </button>
                </div>
                
                <!-- Database Import Section (Admin Only) -->
                <div id="adminOnlySection" class="import-export-section p-6 mb-6 hidden">
                    <h3 class="text-xl font-bold mb-4 text-gray-800 text-center">üì• IMPORT DATABASE EXCEL</h3>
                    <div class="border border-amber-300 rounded-xl p-5 bg-amber-50">
                        <p class="text-sm text-gray-600 mb-4">Import file Excel berisi multiple data sounding sekaligus</p>
                        <input type="file" id="databaseExcelImport" accept=".xlsx,.xls" 
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-amber-50 file:text-amber-700 hover:file:bg-amber-100 mb-4" />
                        <button id="importDatabaseBtn" class="w-full px-4 py-3 gold-gradient text-white rounded-lg hover:shadow-lg transition font-semibold">
                            üöÄ IMPORT DATABASE
                        </button>
                    </div>
                </div>

                <!-- Database Results -->
                <div id="dbResults" class="space-y-6">
                    <div class="text-center p-8 bg-gray-50 rounded-xl">
                        <p class="text-gray-600">Belum ada data database. Generate laporan di section E-SOUNDING untuk menyimpan data.</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- SIMPLE NAVIGATION SCRIPT -->
    <script>
    // Simple Navigation System
    document.addEventListener('DOMContentLoaded', function() {
        // Navigation buttons
        const navButtons = document.querySelectorAll('.nav-btn, .nav-section-btn');
        navButtons.forEach(button => {
            button.addEventListener('click', function() {
                const sectionName = this.getAttribute('data-section');
                if (sectionName) {
                    showSection(sectionName);
                }
            });
        });

        // Home section cards clickable
        const homeCards = document.querySelectorAll('.premium-card');
        homeCards.forEach(card => {
            card.addEventListener('click', function() {
                const targetSection = this.getAttribute('onclick');
                if (targetSection) {
                    // Extract section name from onclick attribute
                    const sectionName = targetSection.replace("showSection('", "").replace("')", "");
                    showSection(sectionName);
                }
            });
        });

        // Show home section by default
        showSection('home');
    });

    function showSection(sectionName) {
        console.log('Showing section:', sectionName);
        
        // Hide all sections
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.add('hidden');
        });
        
        // Remove active class from all buttons
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-white', 'text-gray-800');
            btn.classList.add('bg-gray-700', 'text-white');
        });
        
        // Show target section
        const targetSection = document.getElementById(sectionName + 'Section');
        if (targetSection) {
            targetSection.classList.remove('hidden');
        }
        
        // Activate corresponding button
        const activeButton = document.querySelector(`[data-section="${sectionName}"]`);
        if (activeButton) {
            activeButton.classList.remove('bg-gray-700', 'text-white');
            activeButton.classList.add('active', 'bg-white', 'text-gray-800');
        }

        // Load database data if showing database section
        if (sectionName === 'database') {
            loadDatabaseData();
        }
    }

    // Make function globally available
    window.showSection = showSection;
    </script>

    <!-- MAIN APPLICATION SCRIPT -->
    <script>
    // Global variables
    let signaturePad;
    let currentHoleId = null;
    let currentNorthDirection = null;
    let holeData = {};
    let importData = null;
    let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');

    // Hole Grid Configuration
    const HOLE_ROWS = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O'];
    const MAX_COLUMNS = 30;

    // User credentials
    const USERS = {
        'admin': { password: 'admin123', role: 'admin', name: 'Administrator' },
        'user': { password: 'user123', role: 'user', name: 'Regular User' }
    };

  const DATABASE_CONFIG = {
    useGist: true,
    githubToken: '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', // Ganti dengan token Anda
    gistId: localStorage.getItem('databaseGistId'),
    serverUrl: '' // Kosongkan
};

// Ganti fungsi syncWithGist dengan yang lebih robust:
async function syncWithGist() {
    try {
        // Jika belum ada gistId, buat baru
        if (!DATABASE_CONFIG.gistId) {
            console.log('Membuat Gist baru...');
            return await createNewGist();
        }

        console.log('Mengambil data dari Gist:', DATABASE_CONFIG.gistId);
        
        // Coba ambil data dari gist yang ada
        const response = await fetch(`https://api.github.com/gists/${DATABASE_CONFIG.gistId}`, {
            headers: {
                'Authorization': `token ${DATABASE_CONFIG.githubToken}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        
        if (!response.ok) {
            if (response.status === 404) {
                console.log('Gist tidak ditemukan, membuat baru...');
                return await createNewGist();
            }
            throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }
        
        const gist = await response.json();
        const content = gist.files['sounding_database.json'].content;
        console.log('Berhasil mengambil data dari Gist');
        
        return JSON.parse(content);
    } catch (error) {
        console.error('Gist sync error:', error);
        // Fallback: buat gist baru
        return await createNewGist();
    }
}

    document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
        checkLoginStatus();
    });

    function initializeApp() {
        generateDrillGrid();
        initCompassDirection();
        initSignaturePad();
        setupEventListeners();
        
        // Set default date
        document.getElementById('tanggal').value = new Date().toISOString().split('T')[0];
        
        // Generate user ID
        document.getElementById('userIdDisplay').textContent = generateUserId();
        
        // Load saved data
        setTimeout(loadSessionData, 1000);
        
        // Try to sync database on startup
        setTimeout(() => {
            syncDatabase();
        }, 2000);
    }

    function generateUserId() {
        return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function showNotification(message, isError = false) {
        const el = document.getElementById('notification');
        el.textContent = message;
        el.className = `p-3 mb-4 rounded-lg text-sm transition-opacity duration-300 ${isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
        el.classList.remove('hidden');
        setTimeout(() => {
            el.classList.add('hidden');
        }, 5000);
    }

    // Setup event listeners
    function setupEventListeners() {
        // Excel Import/Export
        document.getElementById('importExcelBtn').addEventListener('click', importFromExcel);
        document.getElementById('confirmImportBtn').addEventListener('click', confirmImport);
        document.getElementById('downloadTemplateBtn').addEventListener('click', downloadTemplate);
        document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
        document.getElementById('exportExcelBtn2').addEventListener('click', exportToExcel);

        // Database Import
        document.getElementById('importDatabaseBtn').addEventListener('click', importDatabaseFromExcel);

        // Share Link
        document.getElementById('generateShareLinkBtn').addEventListener('click', generateShareLink);
        document.getElementById('copyShareLinkBtn').addEventListener('click', copyShareLink);

        // Hole Modal
        document.getElementById('saveHoleDataBtn').addEventListener('click', saveHoleDataFromModal);
        document.getElementById('closeHoleModalBtn').addEventListener('click', closeHoleModal);

        // Signature - FIXED event listeners
        document.getElementById('clearSignatureBtn').addEventListener('click', clearSignature);
        document.getElementById('clearSignatureBtnSmall').addEventListener('click', clearSignature);
        document.getElementById('saveDataBtn').addEventListener('click', saveData);

        // PDF Export
        document.getElementById('generatePdfBtn').addEventListener('click', generateReportAndDownloadPDF);

        // Generate Final Report
        document.getElementById('generateFinalReportBtn').addEventListener('click', generateFinalReport);

        // Copy to clipboard
        document.getElementById('copyToClipboardBtn').addEventListener('click', function() {
            copyToClipboard('copyOutputText');
        });

        // Database Sync
        document.getElementById('syncDatabaseBtn').addEventListener('click', syncDatabase);
        document.getElementById('syncDatabaseBtn2').addEventListener('click', syncDatabase);
        document.getElementById('exportDatabaseBtn').addEventListener('click', exportDatabaseToFile);
        document.getElementById('importDatabaseFileBtn').addEventListener('click', importDatabaseFromFile);
        document.getElementById('clearLocalDatabaseBtn').addEventListener('click', clearLocalDatabase);

        // Form auto-save
        const formInputs = document.querySelectorAll('#generalInfoInputs input, #generalInfoInputs select');
        formInputs.forEach(input => {
            input.addEventListener('change', saveSessionData);
        });

        // Handle window resize for signature pad
        window.addEventListener('resize', function() {
            setTimeout(initSignaturePad, 100);
        });

        // Login/Logout
        document.getElementById('loginBtn').addEventListener('click', showLoginModal);
        document.getElementById('cancelLoginBtn').addEventListener('click', hideLoginModal);
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);

        // TAMBAHAN: Tombol Hapus Semua Lubang
        document.getElementById('clearAllHolesBtn').addEventListener('click', clearAllHoles);
    }

    // ==================== DATABASE SYNC FUNCTIONS ====================

    async function syncDatabase() {
        showNotification("Menyinkronisasi database...", false);
        updateSyncStatus("üîÑ Menyinkronisasi dengan server...");

        try {
            let remoteData = null;

            if (DATABASE_CONFIG.useGist && DATABASE_CONFIG.gistId) {
                // Sync dengan GitHub Gist
                remoteData = await syncWithGist();
            } else {
                // Sync dengan JSON Server
                remoteData = await syncWithJsonServer();
            }

            if (remoteData) {
                // Merge data lokal dengan remote
                const localData = JSON.parse(localStorage.getItem('allSoundingReports') || '[]');
                const mergedData = mergeDatabaseData(localData, remoteData);
                
                // Simpan data yang sudah di-merge
                localStorage.setItem('allSoundingReports', JSON.stringify(mergedData));
                
                updateSyncStatus(`‚úÖ Database tersinkronisasi! Total: ${mergedData.length} laporan`);
                showNotification(`Database berhasil disinkronisasi! Total: ${mergedData.length} laporan`);
                
                // Refresh tampilan database
                if (document.getElementById('databaseSection').classList.contains('hidden') === false) {
                    loadDatabaseData();
                }
            } else {
                updateSyncStatus("‚ÑπÔ∏è Tidak ada data remote yang ditemukan");
            }
        } catch (error) {
            console.error('Sync error:', error);
            updateSyncStatus("‚ùå Gagal sinkronisasi: " + error.message);
            showNotification("Gagal menyinkronisasi database", true);
        }
    }

    async function syncWithGist() {
        if (!DATABASE_CONFIG.gistId) {
            // Buat Gist baru jika belum ada
            return await createNewGist();
        }

        try {
            const response = await fetch(`https://api.github.com/gists/${DATABASE_CONFIG.gistId}`);
            if (!response.ok) throw new Error('Gist tidak ditemukan');
            
            const gist = await response.json();
            const content = gist.files['sounding_database.json'].content;
            return JSON.parse(content);
        } catch (error) {
            console.warn('Gist tidak ditemukan, membuat yang baru...');
            return await createNewGist();
        }
    }

    async function createNewGist() {
        const localData = JSON.parse(localStorage.getItem('allSoundingReports') || '[]');
        const gistData = {
            files: {
                'sounding_database.json': {
                    content: JSON.stringify(localData, null, 2)
                }
            },
            description: 'E-Sounding System Database',
            public: false
        };

        try {
            const response = await fetch('https://api.github.com/gists', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': DATABASE_CONFIG.githubToken ? `token ${DATABASE_CONFIG.githubToken}` : ''
                },
                body: JSON.stringify(gistData)
            });

            if (!response.ok) throw new Error('Gagal membuat Gist');

            const gist = await response.json();
            DATABASE_CONFIG.gistId = gist.id;
            localStorage.setItem('databaseGistId', gist.id);
            
            return localData;
        } catch (error) {
            console.error('Gagal membuat Gist:', error);
            throw error;
        }
    }

    async function syncWithJsonServer() {
        try {
            // Coba ambil data dari server
            const response = await fetch(`${DATABASE_CONFIG.serverUrl}/reports`);
            if (!response.ok) throw new Error('Server tidak merespon');
            
            return await response.json();
        } catch (error) {
            console.error('JSON Server error:', error);
            throw error;
        }
    }

    function mergeDatabaseData(localData, remoteData) {
        const mergedMap = new Map();
        
        // Tambahkan semua data remote
        remoteData.forEach(report => {
            mergedMap.set(report.id, report);
        });
        
        // Tambahkan/update dengan data lokal (local wins jika ada konflik)
        localData.forEach(report => {
            mergedMap.set(report.id, report);
        });
        
        return Array.from(mergedMap.values());
    }

    function exportDatabaseToFile() {
        const allReports = JSON.parse(localStorage.getItem('allSoundingReports') || '[]');
        const dataStr = JSON.stringify(allReports, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `sounding_database_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        URL.revokeObjectURL(url);
        showNotification("Database berhasil diexport ke file!");
    }

    function importDatabaseFromFile() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    const currentData = JSON.parse(localStorage.getItem('allSoundingReports') || '[]');
                    const mergedData = mergeDatabaseData(currentData, importedData);
                    
                    localStorage.setItem('allSoundingReports', JSON.stringify(mergedData));
                    showNotification(`Database berhasil diimport! Total: ${mergedData.length} laporan`);
                    loadDatabaseData();
                } catch (error) {
                    showNotification("File database tidak valid", true);
                }
            };
            
            reader.readAsText(file);
        };
        
        input.click();
    }

    function clearLocalDatabase() {
        if (confirm('Apakah Anda yakin ingin menghapus semua data lokal? Data di server akan tetap aman.')) {
            localStorage.removeItem('allSoundingReports');
            showNotification("Database lokal berhasil dihapus!");
            loadDatabaseData();
        }
    }

    function updateSyncStatus(message) {
        const statusElements = document.querySelectorAll('#syncStatus, #databaseSyncStatus');
        statusElements.forEach(el => {
            if (el) el.textContent = message;
        });
    }

    // ==================== END DATABASE SYNC FUNCTIONS ====================

    // TAMBAHAN: Fungsi untuk menghapus semua data lubang
    function clearAllHoles() {
        if (confirm('Apakah Anda yakin ingin menghapus semua data lubang? Tindakan ini tidak dapat dibatalkan.')) {
            holeData = {};
            
            // Reset semua hole dots
            HOLE_ROWS.forEach(row => {
                for (let col = 1; col <= MAX_COLUMNS; col++) {
                    const holeId = `${row}-${col}`;
                    updateHoleDotUI(holeId);
                }
            });
            
            // Reset row counters
            updateRowCounters();
            
            // Reset plan hole count
            document.getElementById('planHole').value = '';
            
            // Save session
            saveSessionData();
            
            showNotification("Semua data lubang berhasil dihapus!");
        }
    }

    // Login System Functions
    function checkLoginStatus() {
        if (currentUser) {
            updateUIForLoggedInUser();
        }
    }

    function showLoginModal() {
        document.getElementById('loginModal').classList.remove('hidden');
    }

    function hideLoginModal() {
        document.getElementById('loginModal').classList.add('hidden');
        document.getElementById('loginForm').reset();
    }

    function handleLogin(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (!username || !password) {
            showNotification("Username dan password harus diisi", true);
            return;
        }
        
        if (USERS[username] && USERS[username].password === password) {
            currentUser = {
                username: username,
                role: USERS[username].role,
                name: USERS[username].name
            };
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            updateUIForLoggedInUser();
            hideLoginModal();
            showNotification(`Login berhasil! Selamat datang ${currentUser.name}`);
        } else {
            showNotification("Username atau password salah", true);
        }
    }

    function handleLogout() {
        currentUser = null;
        localStorage.removeItem('currentUser');
        updateUIForLoggedOutUser();
        showNotification("Anda telah logout");
    }

    function updateUIForLoggedInUser() {
        document.getElementById('loginBtn').textContent = 'üë§ ' + currentUser.username;
        document.getElementById('userInfoSection').classList.remove('hidden');
        document.getElementById('userRoleDisplay').textContent = currentUser.role === 'admin' ? 'Administrator' : 'User';
        document.getElementById('userNameDisplay').textContent = currentUser.name;
        
        if (currentUser.role === 'admin') {
            document.getElementById('adminOnlySection').classList.remove('hidden');
        }
    }

    function updateUIForLoggedOutUser() {
        document.getElementById('loginBtn').textContent = 'üîê LOGIN';
        document.getElementById('userInfoSection').classList.add('hidden');
        document.getElementById('adminOnlySection').classList.add('hidden');
    }

    function copyToClipboard(elementId) {
        const copyText = document.getElementById(elementId);
        try {
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(copyText.value);
            showNotification("Teks berhasil disalin ke clipboard!");
        } catch (err) {
            console.error('Failed to copy text: ', err);
            showNotification("Gagal menyalin. Silakan salin manual.", true);
        }
    }

    // Kompas Functions - DIREVISI (hapus display arah utara)
    function initCompassDirection() {
        const compassDirections = document.querySelectorAll('.compass-direction');
        
        compassDirections.forEach(direction => {
            direction.addEventListener('click', function() {
                compassDirections.forEach(dir => dir.classList.remove('active'));
                this.classList.add('active');
                currentNorthDirection = this.getAttribute('data-direction');
                updatePdfCompass();
                saveSessionData();
                showNotification(`Arah Utara diatur ke: ${currentNorthDirection.toUpperCase()}`);
            });
        });
    }

    function updatePdfCompass() {
        // Reset all directions
        const directions = ['pdfNorth', 'pdfEast', 'pdfSouth', 'pdfWest'];
        directions.forEach(id => {
            const element = document.getElementById(id);
            element.textContent = '';
            element.classList.remove('active');
        });
        
        // Set active direction based on current selection
        if (currentNorthDirection === 'utara') {
            document.getElementById('pdfNorth').textContent = 'U';
            document.getElementById('pdfNorth').classList.add('active');
        } else if (currentNorthDirection === 'timur') {
            document.getElementById('pdfEast').textContent = 'U';
            document.getElementById('pdfEast').classList.add('active');
        } else if (currentNorthDirection === 'selatan') {
            document.getElementById('pdfSouth').textContent = 'U';
            document.getElementById('pdfSouth').classList.add('active');
        } else if (currentNorthDirection === 'barat') {
            document.getElementById('pdfWest').textContent = 'U';
            document.getElementById('pdfWest').classList.add('active');
        }
    }

    // Signature Pad Functions - DIPERBAIKI untuk freeform drawing
    function initSignaturePad() {
        const canvas = document.getElementById('signatureCanvas');
        const placeholder = document.getElementById('signaturePlaceholder');
        
        if (!canvas) {
            console.error("Canvas element not found!");
            return;
        }

        // Clear any existing signature pad
        if (signaturePad) {
            signaturePad.off();
            signaturePad.clear();
            signaturePad = null;
        }

        // Set canvas size
        const container = canvas.parentElement;
        const rect = container.getBoundingClientRect();
        
        // Set canvas dimensions
        canvas.width = rect.width;
        canvas.height = 150;
        
        // Set CSS size
        canvas.style.width = '100%';
        canvas.style.height = '150px';

        // Initialize SignaturePad dengan konfigurasi yang lebih baik untuk freeform drawing
        signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgb(255, 255, 255)',
            minWidth: 1.5,
            maxWidth: 3.5,
            penColor: 'rgb(0, 0, 0)',
            throttle: 0, // Nonaktifkan throttle untuk responsivitas lebih baik
            velocityFilterWeight: 0.7,
            onBegin: function() {
                placeholder.style.display = 'none';
            },
            onEnd: function() {
                saveSessionData();
            }
        });

        // Enable drawing
        signaturePad.on();
        
        console.log("Signature pad initialized successfully");
        
        // Load saved signature jika ada
        setTimeout(() => {
            const savedData = localStorage.getItem('soundingData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    if (data.signatureBase64) {
                        const img = new Image();
                        img.onload = function() {
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            placeholder.style.display = 'none';
                        };
                        img.src = data.signatureBase64;
                    }
                } catch (error) {
                    console.error("Error loading signature:", error);
                }
            }
        }, 500);
    }

    function clearSignature() {
        if (signaturePad) {
            signaturePad.clear();
            document.getElementById('signaturePlaceholder').style.display = 'block';
            saveSessionData();
            showNotification("Tanda tangan dihapus.");
        }
    }

    // Hole Grid Functions - DIPERBAIKI dengan counter per row
    function generateDrillGrid() {
        const gridContainer = document.getElementById('drillGrid');
        let html = '';

        // Header Row
        html += `<div class="grid-header-cell border-t-0 pdf-grid-header-cell">HOLE ID</div>`;
        html += `<div class="grid-header-cell border-t-0 pdf-grid-header-cell">COUNT</div>`;
        for (let i = 1; i <= MAX_COLUMNS; i++) {
            html += `<div class="grid-header-cell border-t-0 pdf-grid-header-cell">${i}</div>`;
        }

        // Data Rows
        HOLE_ROWS.forEach((holeName, index) => {
            const rowIndex = index + 1;
            
            html += `<div class="grid-row-header pdf-grid-row-header" data-row-index="${rowIndex}">${holeName}</div>`;
            html += `<div class="row-count-cell pdf-row-count-cell" id="count-${holeName}">0</div>`;
            
            for (let col = 1; col <= MAX_COLUMNS; col++) {
                const holeId = `${holeName}-${col}`;
                html += `
                    <div class="hole-cell" data-row-index="${rowIndex}">
                        <div class="staggered-row-content">
                            <span id="dot-${holeId}" 
                                  class="hole-dot pdf-hole-dot rounded-full border-2 border-gray-400 bg-white cursor-pointer text-white relative" 
                                  data-hole-id="${holeId}">
                                <span id="depth-label-${holeId}" class="font-semibold absolute inset-0 flex items-center justify-center"></span>
                            </span>
                        </div>
                    </div>`;
            }
        });

        gridContainer.innerHTML = html;

        // Add click events to hole dots
        HOLE_ROWS.forEach(row => {
            for (let col = 1; col <= MAX_COLUMNS; col++) {
                const holeId = `${row}-${col}`;
                document.getElementById(`dot-${holeId}`).addEventListener('click', function(e) {
                    openHoleModal(holeId, e);
                });
            }
        });
    }

    // Fungsi untuk update counter per row
    function updateRowCounters() {
        HOLE_ROWS.forEach(row => {
            let count = 0;
            for (let col = 1; col <= MAX_COLUMNS; col++) {
                const holeId = `${row}-${col}`;
                if (holeData[holeId] && holeData[holeId].status) {
                    count++;
                }
            }
            document.getElementById(`count-${row}`).textContent = count;
        });
    }

    // DIPERBAIKI: Fungsi untuk membuka modal dekat dengan lubang yang diklik
    function openHoleModal(holeId, event) {
        currentHoleId = holeId;
        const data = holeData[holeId] || { depth: '', status: '' };
        const target = event.target.closest('.hole-dot');
        if (!target) return;

        document.getElementById('modalHoleId').textContent = `Hole: ${holeId}`;
        document.getElementById('holeDepth').value = data.depth || '';
        document.getElementById('holeCondition').value = data.status || '';

        const rect = target.getBoundingClientRect();
        const modal = document.getElementById('holeModal');
        
        // Hitung posisi modal agar dekat dengan lubang yang diklik
        const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
        const scrollY = window.pageYOffset || document.documentElement.scrollTop;
        
        // Posisi modal di sebelah kanan lubang
        let posX = rect.left + scrollX + rect.width + 10;
        let posY = rect.top + scrollY - 50;
        
        // Jika posisi X terlalu ke kanan, pindah ke kiri
        if (posX + modal.offsetWidth > window.innerWidth) {
            posX = rect.left + scrollX - modal.offsetWidth - 10;
        }
        
        // Jika posisi Y terlalu ke bawah, sesuaikan
        if (posY + modal.offsetHeight > window.innerHeight) {
            posY = window.innerHeight - modal.offsetHeight - 10;
        }
        
        // Jika posisi Y terlalu ke atas, sesuaikan
        if (posY < 10) {
            posY = 10;
        }

        modal.style.top = `${posY}px`;
        modal.style.left = `${posX}px`;
        modal.style.transform = 'none'; // Hapus transform sebelumnya

        modal.classList.remove('hidden');
        
        // Tambahkan event listener untuk menutup modal saat klik di luar
        setTimeout(() => {
            document.addEventListener('click', closeModalOnClickOutside);
        }, 10);
    }

    // Fungsi untuk menutup modal saat klik di luar
    function closeModalOnClickOutside(event) {
        const modal = document.getElementById('holeModal');
        if (!modal.contains(event.target) && !event.target.closest('.hole-dot')) {
            closeHoleModal();
        }
    }

    function saveHoleDataFromModal() {
        if (!currentHoleId) return;

        const depth = document.getElementById('holeDepth').value;
        const status = document.getElementById('holeCondition').value;

        if (!depth || !status) {
            showNotification("Mohon isi Kedalaman dan Kondisi Lubang.", true);
            return;
        }

        holeData[currentHoleId] = {
            depth: parseFloat(depth).toFixed(1),
            status: status
        };

        updateHoleDotUI(currentHoleId);
        updateRowCounters(); // Update counter setelah menyimpan data
        closeHoleModal();
        saveSessionData();
        updatePreviewData();
    }

    function closeHoleModal() {
        document.getElementById('holeModal').classList.add('hidden');
        currentHoleId = null;
        // Hapus event listener untuk menutup modal saat klik di luar
        document.removeEventListener('click', closeModalOnClickOutside);
    }

    function updateHoleDotUI(holeId) {
        const data = holeData[holeId] || { depth: '0.0', status: '' };
        const dot = document.getElementById(`dot-${holeId}`);
        const depthLabel = document.getElementById(`depth-label-${holeId}`);
        
        if (!dot || !depthLabel) return;
        
        const status = data.status;
        const depth = data.depth;

        let colorStatus = '';
        if (status === 'Kering') colorStatus = 'D';
        else if (status === 'Basah') colorStatus = 'W';
        else if (status === 'Collapse') colorStatus = 'C';

        dot.classList.remove('status-D', 'status-W', 'status-C', 'border-gray-500'); 
        dot.classList.add('bg-white', 'border-gray-400');

        if (colorStatus === 'D') dot.classList.add('status-D', 'border-gray-500');
        else if (colorStatus === 'W') dot.classList.add('status-W', 'border-gray-500');
        else if (colorStatus === 'C') dot.classList.add('status-C', 'border-gray-500');

        if (depth && status) {
            depthLabel.textContent = depth;
            dot.classList.remove('text-gray-700');
            depthLabel.classList.remove('text-gray-700');
            dot.classList.add('text-white');
            depthLabel.classList.add('text-white');
        } else {
            depthLabel.textContent = '';
            dot.classList.add('text-gray-700');
        }
        
        dot.title = `Kedalaman: ${depth || 'Belum Diisi'}, Kondisi: ${status || 'Belum Diisi'}`;
    }

    // Excel Import/Export Functions
    function downloadTemplate() {
        try {
            const templateData = [
                ['ID HOLE', 'DEPTH HOLE (m)', 'HOLE CONDITION'],
                ['A-1', '6.5', 'Kering'],
                ['A-2', '7.2', 'Basah'],
                ['A-3', '5.8', 'Collapse'],
                ['B-1', '6.9', 'Kering'],
                ['B-2', '7.5', 'Kering']
            ];

            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template Sounding");
            
            XLSX.writeFile(wb, `Sounding_Template_${new Date().toISOString().split('T')[0]}.xlsx`);
            showNotification("Template Excel berhasil didownload!");
            
        } catch (error) {
            console.error("Error downloading template:", error);
            showNotification(`Gagal download template: ${error.message}`, true);
        }
    }

    function importFromExcel() {
        const fileInput = document.getElementById('excelImport');
        const file = fileInput.files[0];
        
        if (!file) {
            showNotification("Pilih file Excel terlebih dahulu!", true);
            return;
        }
        
        showNotification("Memproses file Excel...", false);
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                // Validasi header
                if (jsonData.length < 1 || 
                    jsonData[0][0] !== 'ID HOLE' || 
                    jsonData[0][1] !== 'DEPTH HOLE (m)' || 
                    jsonData[0][2] !== 'HOLE CONDITION') {
                    throw new Error("Format Excel tidak sesuai. Gunakan template yang disediakan.");
                }
                
                // Process data
                importData = {};
                let validRows = 0;
                let previewHtml = '';
                
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row && row.length >= 3 && row[0] && row[1] && row[2]) {
                        const holeId = row[0].toString().trim();
                        const depth = parseFloat(row[1]);
                        const condition = row[2].toString().trim();
                        
                        // Validasi hole ID format
                        if (!/^[A-O]-\d+$/.test(holeId)) {
                            console.warn(`Format ID HOLE tidak valid: ${holeId}`);
                            continue;
                        }
                        
                        // Validasi condition
                        const validConditions = ['Kering', 'Basah', 'Collapse'];
                        if (!validConditions.includes(condition)) {
                            console.warn(`Kondisi tidak valid: ${condition}`);
                            continue;
                        }
                        
                        importData[holeId] = {
                            depth: depth.toFixed(1),
                            status: condition
                        };
                        validRows++;
                        
                        // Build preview (max 5 rows)
                        if (validRows <= 5) {
                            previewHtml += `<div class="py-1 border-b border-gray-200">${holeId}: ${depth}m (${condition})</div>`;
                        }
                    }
                }
                
                if (validRows === 0) {
                    throw new Error("Tidak ada data valid yang ditemukan dalam file Excel.");
                }
                
                // Show preview
                document.getElementById('importPreviewContent').innerHTML = 
                    `${previewHtml}<div class="text-amber-600 font-semibold mt-2 py-1 border-t border-gray-300">Total: ${validRows} data valid</div>`;
                document.getElementById('importPreview').classList.remove('hidden');
                
                showNotification(`Berhasil memproses ${validRows} data dari Excel!`);
                
            } catch (error) {
                console.error("Error processing Excel:", error);
                showNotification(`Gagal memproses Excel: ${error.message}`, true);
            }
        };
        
        reader.onerror = function() {
            showNotification("Gagal membaca file Excel", true);
        };
        
        reader.readAsArrayBuffer(file);
    }

    function confirmImport() {
        if (!importData || Object.keys(importData).length === 0) {
            showNotification("Tidak ada data untuk di-import!", true);
            return;
        }
        
        console.log("Data sebelum import:", holeData);
        
        // Apply imported data to holeData - PERBAIKAN: Gunakan spread operator untuk menggabungkan data
        holeData = { ...holeData, ...importData };
        
        console.log("Data setelah import:", holeData);
        
        // Update ALL hole dots - PERBAIKAN: Update semua dot, bukan hanya yang di-import
        HOLE_ROWS.forEach(row => {
            for (let col = 1; col <= MAX_COLUMNS; col++) {
                const holeId = `${row}-${col}`;
                updateHoleDotUI(holeId);
            }
        });
        
        // Update row counters
        updateRowCounters();
        
        // Update plan hole count
        const currentPlanHole = document.getElementById('planHole').value;
        const importedCount = Object.keys(importData).length;
        const totalHoles = Object.keys(holeData).filter(id => holeData[id].status).length;
        
        if (!currentPlanHole || parseInt(currentPlanHole) < totalHoles) {
            document.getElementById('planHole').value = totalHoles;
        }
        
        // Save to session
        saveSessionData();
        
        showNotification(`‚úÖ Berhasil import ${Object.keys(importData).length} data lubang! Total data: ${totalHoles} lubang`);
        document.getElementById('importPreview').classList.add('hidden');
        document.getElementById('excelImport').value = '';
        
        importData = null;
        
        // Update preview
        updatePreviewData();
    }

    function exportToExcel() {
        if (Object.keys(holeData).length === 0) {
            showNotification("Tidak ada data lubang untuk diexport.", true);
            return;
        }

        try {
            const excelData = [['ID HOLE', 'DEPTH HOLE (m)', 'HOLE CONDITION']];
            
            HOLE_ROWS.forEach(row => {
                for (let col = 1; col <= MAX_COLUMNS; col++) {
                    const holeId = `${row}-${col}`;
                    const data = holeData[holeId];
                    if (data && data.status) {
                        excelData.push([holeId, data.depth || '', data.status || '']);
                    }
                }
            });

            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Hole Data");
            
            const fileName = `Sounding_Data_${document.getElementById('lokasi').value || 'Report'}_${document.getElementById('tanggal').value || new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showNotification("Data berhasil diexport ke Excel!");
            
        } catch (error) {
            console.error("Error exporting to Excel:", error);
            showNotification(`Gagal export Excel: ${error.message}`, true);
        }
    }

    // Database Functions
    function loadDatabaseData() {
        // Load dari localStorage (akan di-sync dengan server)
        const allReports = JSON.parse(localStorage.getItem('allSoundingReports') || '[]');
        const dbResults = document.getElementById('dbResults');
        
        if (allReports.length === 0) {
            dbResults.innerHTML = `
                <div class="text-center p-8 bg-gray-50 rounded-xl">
                    <p class="text-gray-600">Belum ada data database. Generate laporan di section E-SOUNDING untuk menyimpan data.</p>
                </div>
            `;
            return;
        }

        let html = '';
        
        // Sort reports by timestamp (newest first)
        allReports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        allReports.forEach((report, index) => {
            const stats = report.statistics || calculateStatisticsFromReport(report);
            
            // Format nama file: LOKASI_TANGGAL
            const fileName = `${report.lokasi || 'Unknown'}_${report.tanggal || 'NoDate'}`;
            
            html += `
                <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">${fileName}</h3>
                            <p class="text-sm text-gray-600">${report.tanggal} | ${report.shift} | ${report.pit}</p>
                            <p class="text-xs text-gray-500">Dibuat oleh: ${report.createdBy || 'unknown'} | ${new Date(report.timestamp).toLocaleString()}</p>
                        </div>
                        <span class="px-3 py-1 bg-amber-100 text-amber-800 rounded-full text-sm font-semibold">
                            ${stats.totalHoles} Lubang
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-sm">
                        <div>
                            <span class="text-gray-600">Plan Hole:</span>
                            <span class="font-semibold ml-1">${report.planHole || '-'}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">B x S:</span>
                            <span class="font-semibold ml-1">${report.burden || '-'} x ${report.spasi || '-'}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Rata Kedalaman:</span>
                            <span class="font-semibold ml-1">${stats.avgDepth} m</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Kering:</span>
                            <span class="font-semibold ml-1 text-green-600">${stats.dryPercentage}%</span>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">Crew: ${report.namaCrew || '-'} | GL: ${report.namaGL || '-'}</span>
                        <div class="space-x-2">
                            <button onclick="loadReportToForm('${report.id}')" class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition">
                                üìã Load
                            </button>
                            <button onclick="viewReportGrid('${report.id}')" class="px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600 transition">
                                üëÅÔ∏è View Grid
                            </button>
                            <button onclick="downloadReportPDF('${report.id}')" class="px-3 py-1 bg-purple-500 text-white text-sm rounded hover:bg-purple-600 transition">
                                üìÑ PDF
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        dbResults.innerHTML = html;
    }

    function calculateStatisticsFromReport(report) {
        const filledHoles = Object.values(report.holeData || {}).filter(d => d.status);
        const actualHoles = filledHoles.length;
        
        const validDepths = filledHoles
            .map(d => parseFloat(d.depth))
            .filter(d => !isNaN(d) && d > 0);

        const totalDepth = validDepths.reduce((sum, d) => sum + d, 0);
        const avgDepth = validDepths.length > 0 ? (totalDepth / validDepths.length).toFixed(2) : '0.0';

        const dryCount = filledHoles.filter(d => d.status === 'Kering').length;
        const dryPercentage = actualHoles > 0 ? ((dryCount / actualHoles) * 100).toFixed(0) : '0';

        return {
            totalHoles: actualHoles,
            avgDepth: avgDepth,
            dryPercentage: dryPercentage,
            wetCount: filledHoles.filter(d => d.status === 'Basah').length,
            collapseCount: filledHoles.filter(d => d.status === 'Collapse').length
        };
    }

    function loadReportToForm(reportId) {
        const allReports = JSON.parse(localStorage.getItem('allSoundingReports') || '[]');
        const report = allReports.find(r => r.id === reportId);
        if (!report) {
            showNotification("Laporan tidak ditemukan", true);
            return;
        }
        
        // Load form data
        document.getElementById('pit').value = report.pit || '';
        document.getElementById('shift').value = report.shift || '';
        document.getElementById('lokasi').value = report.lokasi || '';
        document.getElementById('tanggal').value = report.tanggal || '';
        document.getElementById('planHole').value = report.planHole || '';
        document.getElementById('namaCrew').value = report.namaCrew || '';
        document.getElementById('namaGL').value = report.namaGL || '';
        document.getElementById('burden').value = report.burden || '';
        document.getElementById('spasi').value = report.spasi || '';
        document.getElementById('unitDrilling').value = report.unitDrilling || '';
        
        // Load hole data
        holeData = {...report.holeData};
        
        // Update ALL hole dots
        HOLE_ROWS.forEach(row => {
            for (let col = 1; col <= MAX_COLUMNS; col++) {
                const holeId = `${row}-${col}`;
                updateHoleDotUI(holeId);
            }
        });
        
        // Update row counters
        updateRowCounters();
        
        // Load signature
        if (report.signatureBase64 && signaturePad) {
            // Clear first
            signaturePad.clear();
            
            // Create temporary image to load signature
            const img = new Image();
            img.onload = function() {
                const ctx = signaturePad.canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, signaturePad.canvas.width, signaturePad.canvas.height);
                document.getElementById('signaturePlaceholder').style.display = 'none';
            };
            img.src = report.signatureBase64;
        }
        
        // Load north direction
        if (report.northDirection) {
            currentNorthDirection = report.northDirection;
            updatePdfCompass();
            
            // Activate corresponding compass direction
            const compassDirections = document.querySelectorAll('.compass-direction');
            compassDirections.forEach(dir => {
                dir.classList.remove('active');
                if (dir.getAttribute('data-direction') === currentNorthDirection) {
                    dir.classList.add('active');
                }
            });
        }
        
        // Save to session
        saveSessionData();
        
        // Switch to e-sounding section
        showSection('e-sounding');
        
        showNotification(`Laporan ${report.lokasi} berhasil dimuat!`);
    }

    function viewReportGrid(reportId) {
        const allReports = JSON.parse(localStorage.getItem('allSoundingReports') || '[]');
        const report = allReports.find(r => r.id === reportId);
        if (!report) {
            showNotification("Laporan tidak ditemukan", true);
            return;
        }

        // Create modal to show grid visualization
        const modalHtml = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-2xl p-6 max-w-4xl max-h-[90vh] overflow-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Grid Visualization - ${report.lokasi}</h3>
                        <button onclick="closeGridModal()" class="text-gray-500 hover:text-gray-700">
                            ‚úï
                        </button>
                    </div>
                    <div id="databaseGridContainer" class="border rounded-lg p-4 bg-gray-50">
                        <!-- Grid will be generated here -->
                    </div>
                    <div class="mt-4 text-sm text-gray-600">
                        <p><strong>Tanggal:</strong> ${report.tanggal} | <strong>Shift:</strong> ${report.shift} | <strong>PIT:</strong> ${report.pit}</p>
                        <p><strong>Lokasi:</strong> ${report.lokasi} | <strong>Plan Hole:</strong> ${report.planHole}</p>
                    </div>
                </div>
            </div>
        `;
        
        const modal = document.createElement('div');
        modal.innerHTML = modalHtml;
        document.body.appendChild(modal);

        // Generate grid for this report
        generateDatabaseGrid(report, 'databaseGridContainer');
    }

    function closeGridModal() {
        const modal = document.querySelector('.fixed.inset-0');
        if (modal) {
            modal.remove();
        }
    }

    function generateDatabaseGrid(report, containerId) {
        const container = document.getElementById(containerId);
        let html = '<div class="database-grid">';

        // Header Row
        html += `<div class="grid-header-cell border-t-0">HOLE ID</div>`;
        html += `<div class="grid-header-cell border-t-0">COUNT</div>`;
        for (let i = 1; i <= MAX_COLUMNS; i++) {
            html += `<div class="grid-header-cell border-t-0">${i}</div>`;
        }

        // Data Rows
        HOLE_ROWS.forEach((holeName, index) => {
            const rowIndex = index + 1;
            
            // Hitung jumlah lubang yang terisi untuk row ini
            let rowCount = 0;
            for (let col = 1; col <= MAX_COLUMNS; col++) {
                const holeId = `${holeName}-${col}`;
                if (report.holeData[holeId] && report.holeData[holeId].status) {
                    rowCount++;
                }
            }
            
            html += `<div class="grid-row-header" data-row-index="${rowIndex}">${holeName}</div>`;
            html += `<div class="row-count-cell">${rowCount}</div>`;
            
            for (let col = 1; col <= MAX_COLUMNS; col++) {
                const holeId = `${holeName}-${col}`;
                const data = report.holeData[holeId] || { depth: '', status: '' };
                const status = data.status;
                const depth = data.depth;

                let colorStatus = '';
                if (status === 'Kering') colorStatus = 'D';
                else if (status === 'Basah') colorStatus = 'W';
                else if (status === 'Collapse') colorStatus = 'C';

                let dotClass = 'hole-dot rounded-full border-2 border-gray-400 bg-white cursor-pointer text-white relative';
                if (colorStatus === 'D') dotClass += ' status-D border-gray-500';
                else if (colorStatus === 'W') dotClass += ' status-W border-gray-500';
                else if (colorStatus === 'C') dotClass += ' status-C border-gray-500';

                html += `
                    <div class="hole-cell" data-row-index="${rowIndex}">
                        <div class="staggered-row-content">
                            <span class="${dotClass}" style="width: 18px; height: 18px; font-size: 0.45rem;">
                                <span class="font-semibold absolute inset-0 flex items-center justify-center">
                                    ${depth && status ? depth : ''}
                                </span>
                            </span>
                        </div>
                    </div>`;
            }
        });

        html += '</div>';
        container.innerHTML = html;
    }

    function deleteReport(reportId) {
        if (!currentUser || currentUser.role !== 'admin') {
            showNotification("Anda tidak memiliki akses untuk menghapus laporan", true);
            return;
        }
        
        if (confirm('Apakah Anda yakin ingin menghapus laporan ini?')) {
            const allReports = JSON.parse(localStorage.getItem('allSoundingReports') || '[]');
            const updatedReports = allReports.filter(report => report.id !== reportId);
            localStorage.setItem('allSoundingReports', JSON.stringify(updatedReports));
            loadDatabaseData();
            showNotification("Laporan berhasil dihapus");
        }
    }

    function importDatabaseFromExcel() {
        if (!currentUser || currentUser.role !== 'admin') {
            showNotification("Hanya admin yang dapat mengimpor database", true);
            return;
        }
        
        const fileInput = document.getElementById('databaseExcelImport');
        const file = fileInput.files[0];
        
        if (!file) {
            showNotification("Pilih file Excel terlebih dahulu!", true);
            return;
        }
        
        showNotification("Memproses database Excel...", false);
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                let importedCount = 0;
                
                // Process each sheet
                workbook.SheetNames.forEach(sheetName => {
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    
                    // Skip if not enough rows or wrong header
                    if (jsonData.length < 2 || 
                        jsonData[0][0] !== 'ID HOLE' || 
                        jsonData[0][1] !== 'DEPTH HOLE (m)' || 
                        jsonData[0][2] !== 'HOLE CONDITION') {
                        return;
                    }
                    
                    // Extract metadata from sheet name or first rows
                    const reportData = {
                        id: 'db_import_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        pit: extractPitFromSheetName(sheetName),
                        shift: 'SHIFT 1', // Default
                        lokasi: sheetName,
                        tanggal: new Date().toISOString().split('T')[0],
                        planHole: 0,
                        holeData: {},
                        timestamp: new Date().toISOString(),
                        createdBy: currentUser ? currentUser.username : 'admin_import'
                    };
                    
                    // Process hole data
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row && row.length >= 3 && row[0] && row[1] && row[2]) {
                            const holeId = row[0].toString().trim();
                            const depth = parseFloat(row[1]);
                            const condition = row[2].toString().trim();
                            
                            if (/^[A-O]-\d+$/.test(holeId) && ['Kering', 'Basah', 'Collapse'].includes(condition)) {
                                reportData.holeData[holeId] = {
                                    depth: depth.toFixed(1),
                                    status: condition
                                };
                                reportData.planHole++;
                            }
                        }
                    }
                    
                    if (Object.keys(reportData.holeData).length > 0) {
                        const allReports = JSON.parse(localStorage.getItem('allSoundingReports') || '[]');
                        allReports.push(reportData);
                        localStorage.setItem('allSoundingReports', JSON.stringify(allReports));
                        importedCount++;
                    }
                });
                
                if (importedCount > 0) {
                    showNotification(`‚úÖ Berhasil import ${importedCount} laporan dari database Excel!`);
                    loadDatabaseData();
                } else {
                    showNotification("Tidak ada data valid yang ditemukan dalam file Excel.", true);
                }
                
            } catch (error) {
                console.error("Error processing database Excel:", error);
                showNotification(`Gagal memproses database Excel: ${error.message}`, true);
            }
        };
        
        reader.onerror = function() {
            showNotification("Gagal membaca file Excel", true);
        };
        
        reader.readAsArrayBuffer(file);
    }

    function extractPitFromSheetName(sheetName) {
        if (sheetName.includes('Tempudo 2')) return 'Tempudo 2';
        if (sheetName.includes('Tempudo 3')) return 'Tempudo 3';
        if (sheetName.includes('Tempudo 4')) return 'Tempudo 4';
        return 'Tempudo 2'; // Default
    }

    // Share Link Functions
    function generateShareLink() {
        const userId = document.getElementById('userIdDisplay').textContent;
        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

        const baseUrl = window.location.href.split('?')[0];
        const shareUrl = `${baseUrl}?session=${sessionId}&user=${userId}`;
        
        document.getElementById('shareableLink').value = shareUrl;
        document.getElementById('shareLinkContainer').classList.remove('hidden');
        
        saveSessionData();
        
        showNotification("Link berhasil dibuat! Salin dan simpan untuk melanjutkan nanti.");
    }

    function copyShareLink() {
        const shareLink = document.getElementById('shareableLink');
        copyToClipboard('shareableLink');
    }

    // Data Management - FIXED signature saving
    function saveData() {
        // Save current report to database
        saveReportToDatabase();
        saveSessionData();
        showNotification("Data Laporan berhasil disimpan!");
    }

    function saveSessionData() {
        let signatureBase64 = '';
        if (signaturePad && !signaturePad.isEmpty()) {
            // Get signature data with proper scaling
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // Set reasonable size for storage
            tempCanvas.width = 400;
            tempCanvas.height = 150;
            
            // Draw signature to temp canvas
            tempCtx.drawImage(signaturePad.canvas, 0, 0, tempCanvas.width, tempCanvas.height);
            signatureBase64 = tempCanvas.toDataURL();
        }
        
        // Simpan ke localStorage sebagai fallback
        const sessionData = {
            pit: document.getElementById('pit').value,
            shift: document.getElementById('shift').value,
            lokasi: document.getElementById('lokasi').value,
            tanggal: document.getElementById('tanggal').value,
            planHole: document.getElementById('planHole').value,
            namaCrew: document.getElementById('namaCrew').value,
            namaGL: document.getElementById('namaGL').value,
            burden: document.getElementById('burden').value,
            spasi: document.getElementById('spasi').value,
            unitDrilling: document.getElementById('unitDrilling').value,
            holeData: holeData,
            signatureBase64: signatureBase64,
            northDirection: currentNorthDirection,
            timestamp: new Date().toISOString()
        };
        
        localStorage.setItem('soundingData', JSON.stringify(sessionData));
        console.log("Data session tersimpan di localStorage");
    }

    function saveReportToDatabase() {
        const signatureBase64 = signaturePad && !signaturePad.isEmpty() ? signaturePad.toDataURL() : '';
        
        const report = {
            id: 'report_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            pit: document.getElementById('pit').value,
            shift: document.getElementById('shift').value,
            lokasi: document.getElementById('lokasi').value,
            tanggal: document.getElementById('tanggal').value,
            planHole: document.getElementById('planHole').value,
            namaCrew: document.getElementById('namaCrew').value,
            namaGL: document.getElementById('namaGL').value,
            burden: document.getElementById('burden').value,
            spasi: document.getElementById('spasi').value,
            unitDrilling: document.getElementById('unitDrilling').value,
            holeData: {...holeData},
            signatureBase64: signatureBase64,
            northDirection: currentNorthDirection,
            timestamp: new Date().toISOString(),
            statistics: calculateStatistics(),
            createdBy: currentUser ? currentUser.username : 'anonymous'
        };
        
        // Load existing reports from localStorage
        let allReports = JSON.parse(localStorage.getItem('allSoundingReports') || '[]');
        
        // Add new report
        allReports.push(report);
        
        // Save back to localStorage
        localStorage.setItem('allSoundingReports', JSON.stringify(allReports));
        
        console.log("Report saved to database:", report.id);
        
        // Coba sync dengan server
        setTimeout(() => {
            syncDatabase();
        }, 1000);
        
        return report.id;
    }

    function calculateStatistics() {
        const filledHoles = Object.values(holeData).filter(d => d.status);
        const actualHoles = filledHoles.length;
        
        const validDepths = filledHoles
            .map(d => parseFloat(d.depth))
            .filter(d => !isNaN(d) && d > 0);

        const totalDepth = validDepths.reduce((sum, d) => sum + d, 0);
        const avgDepth = validDepths.length > 0 ? (totalDepth / validDepths.length).toFixed(2) : '0.0';

        const dryCount = filledHoles.filter(d => d.status === 'Kering').length;
        const dryPercentage = actualHoles > 0 ? ((dryCount / actualHoles) * 100).toFixed(0) : '0';

        return {
            totalHoles: actualHoles,
            avgDepth: avgDepth,
            dryPercentage: dryPercentage,
            wetCount: filledHoles.filter(d => d.status === 'Basah').length,
            collapseCount: filledHoles.filter(d => d.status === 'Collapse').length
        };
    }

    function loadSessionData() {
        const savedData = localStorage.getItem('soundingData');
        if (savedData) {
            try {
                const data = JSON.parse(savedData);
                
                // Load form data
                document.getElementById('pit').value = data.pit || '';
                document.getElementById('shift').value = data.shift || '';
                document.getElementById('lokasi').value = data.lokasi || '';
                document.getElementById('tanggal').value = data.tanggal || '';
                document.getElementById('planHole').value = data.planHole || '';
                document.getElementById('namaCrew').value = data.namaCrew || '';
                document.getElementById('namaGL').value = data.namaGL || '';
                document.getElementById('burden').value = data.burden || '';
                document.getElementById('spasi').value = data.spasi || '';
                document.getElementById('unitDrilling').value = data.unitDrilling || '';
                
                // Load hole data
                if (data.holeData) {
                    holeData = data.holeData;
                    
                    // Update ALL hole dots
                    HOLE_ROWS.forEach(row => {
                        for (let col = 1; col <= MAX_COLUMNS; col++) {
                            const holeId = `${row}-${col}`;
                            updateHoleDotUI(holeId);
                        }
                    });
                }
                
                // Update row counters
                updateRowCounters();
                
                // Load signature - FIXED
                if (data.signatureBase64 && signaturePad) {
                    // Clear first
                    signaturePad.clear();
                    
                    // Create temporary image to load signature
                    const img = new Image();
                    img.onload = function() {
                        const ctx = signaturePad.canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, signaturePad.canvas.width, signaturePad.canvas.height);
                        document.getElementById('signaturePlaceholder').style.display = 'none';
                    };
                    img.src = data.signatureBase64;
                }
                
                // Load north direction
                if (data.northDirection) {
                    currentNorthDirection = data.northDirection;
                    updatePdfCompass();
                    
                    // Activate corresponding compass direction
                    const compassDirections = document.querySelectorAll('.compass-direction');
                    compassDirections.forEach(dir => {
                        if (dir.getAttribute('data-direction') === currentNorthDirection) {
                            dir.classList.add('active');
                        }
                    });
                }
                
                console.log("Data session berhasil dimuat");
                showNotification("Data sebelumnya berhasil dimuat!");
                
            } catch (error) {
                console.error("Error loading session data:", error);
                showNotification("Gagal memuat data sebelumnya", true);
            }
        }
        
        updatePreviewData();
    }

    function updatePreviewData() {
        const stats = calculateStatistics();
        
        document.getElementById('statTotalHoles').textContent = stats.totalHoles;
        document.getElementById('statAvgDepth').textContent = stats.avgDepth + ' m';
        document.getElementById('statDryPercentage').textContent = stats.dryPercentage + '%';
        
        // Update current data preview
        const currentDataEl = document.getElementById('currentData');
        if (stats.totalHoles > 0) {
            currentDataEl.innerHTML = `
                <div class="bg-white rounded-xl p-4 shadow border border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-gray-700">Lokasi:</span>
                        <span class="text-gray-900">${document.getElementById('lokasi').value || '-'}</span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-gray-700">Total Lubang:</span>
                        <span class="text-amber-600 font-bold">${stats.totalHoles}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-gray-700">Kondisi Kering:</span>
                        <span class="text-green-600 font-bold">${stats.dryPercentage}%</span>
                    </div>
                </div>
            `;
        }
    }

    // PDF Generation Functions - DIPERBAIKI untuk landscape 1 halaman dengan ukuran lebih besar dan penuh
    function generateReportAndDownloadPDF() {
        // Update report data first
        updateReportData();
        
        // Show loading notification
        showNotification("Membuat PDF... Harap tunggu");
        
        // Use html2canvas and jsPDF
        const { jsPDF } = window.jspdf;
        
        const element = document.getElementById('pdfCaptureArea');
        
        // Store original styles
        const originalWidth = element.style.width;
        const originalMaxWidth = element.style.maxWidth;
        const originalPadding = element.style.padding;
        
        // Optimize for PDF - set fixed width untuk landscape
        element.style.width = '1200px';
        element.style.maxWidth = '1200px';
        element.style.padding = '15px';
        
        // Apply PDF-specific styles
        element.classList.add('pdf-optimized');
        
        // Use html2canvas dengan scale yang optimal
        html2canvas(element, {
            scale: 2.2,
            useCORS: true,
            allowTaint: false,
            logging: false,
            backgroundColor: "#ffffff",
            width: 1200,
            height: element.scrollHeight,
            windowWidth: 1200,
            onclone: function(clonedDoc) {
                // Apply PDF-specific optimizations
                const clonedElement = clonedDoc.getElementById('pdfCaptureArea');
                if (clonedElement) {
                    clonedElement.style.width = '1200px';
                    clonedElement.style.maxWidth = '1200px';
                    clonedElement.style.padding = '15px';
                    
                    // Show PDF-only elements
                    const pdfOnlyElements = clonedElement.querySelectorAll('.pdf-only');
                    pdfOnlyElements.forEach(el => {
                        el.style.display = 'block';
                    });
                    
                    // Hide screen-only elements
                    const screenOnlyElements = clonedElement.querySelectorAll('.screen-only');
                    screenOnlyElements.forEach(el => {
                        el.style.display = 'none';
                    });
                    
                    // Perbesar font untuk PDF
                    const textElements = clonedElement.querySelectorAll('.text-lg, .text-md, .text-sm, .text-xs');
                    textElements.forEach(el => {
                        if (el.classList.contains('text-lg')) el.style.fontSize = '1.3rem';
                        if (el.classList.contains('text-md')) el.style.fontSize = '1.1rem';
                        if (el.classList.contains('text-sm')) el.style.fontSize = '1rem';
                        if (el.classList.contains('text-xs')) el.style.fontSize = '0.9rem';
                    });
                    
                    // Perbesar font depth hole - PERBAIKAN: Font diperbesar
                    const depthLabels = clonedElement.querySelectorAll('.pdf-hole-dot span');
                    depthLabels.forEach(label => {
                        label.style.fontSize = '0.7rem';
                        label.style.fontWeight = 'bold';
                    });
                }
            }
        }).then(canvas => {
            // Restore original styles
            element.style.width = originalWidth;
            element.style.maxWidth = originalMaxWidth;
            element.style.padding = originalPadding;
            element.classList.remove('pdf-optimized');
            
            const imgData = canvas.toDataURL('image/jpeg', 0.92);
            const pdf = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });

            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            
            // Calculate dimensions to fit the page
            const imgWidth = pageWidth - 10; // Margin 5mm each side
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            // Center the image on the page
            const x = (pageWidth - imgWidth) / 2;
            const y = (pageHeight - imgHeight) / 2;
            
            // Add image centered on page
            pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);
            
            // Generate filename
            const pit = document.getElementById('pit').value || 'Unknown';
            const lokasi = document.getElementById('lokasi').value || 'Unknown';
            const tanggal = document.getElementById('tanggal').value || new Date().toISOString().split('T')[0];
            const filename = `Sounding_Report_${pit}_${lokasi}_${tanggal}.pdf`;
            
            // Save PDF
            pdf.save(filename);
            
            showNotification("PDF berhasil di-download dalam 1 halaman landscape!");
            
        }).catch(error => {
            console.error("Error generating PDF:", error);
            // Restore original styles on error
            element.style.width = originalWidth;
            element.style.maxWidth = originalMaxWidth;
            element.style.padding = originalPadding;
            element.classList.remove('pdf-optimized');
            showNotification("Gagal membuat PDF: " + error.message, true);
        });
    }

    // Fungsi untuk download PDF dari database
    function downloadReportPDF(reportId) {
        const allReports = JSON.parse(localStorage.getItem('allSoundingReports') || '[]');
        const report = allReports.find(r => r.id === reportId);
        
        if (!report) {
            showNotification("Laporan tidak ditemukan", true);
            return;
        }
        
        // Load report data ke form sementara
        const currentHoleData = holeData;
        const currentNorthDir = currentNorthDirection;
        
        // Set data dari report
        holeData = report.holeData;
        currentNorthDirection = report.northDirection;
        
        // Update UI sementara
        updateReportData();
        
        // Generate PDF
        setTimeout(() => {
            generateReportAndDownloadPDF();
            
            // Kembalikan data asli
            setTimeout(() => {
                holeData = currentHoleData;
                currentNorthDirection = currentNorthDir;
                updateReportData();
            }, 1000);
        }, 500);
    }

    // Fungsi Generate Final Report - BARU
    function generateFinalReport() {
        // Validasi data
        const requiredFields = ['tanggal', 'shift', 'pit', 'lokasi', 'planHole', 'namaCrew', 'namaGL'];
        const missingFields = [];
        
        requiredFields.forEach(field => {
            if (!document.getElementById(field).value) {
                missingFields.push(field);
            }
        });
        
        if (missingFields.length > 0) {
            showNotification(`Mohon lengkapi field: ${missingFields.join(', ')}`, true);
            return;
        }
        
        if (Object.keys(holeData).length === 0) {
            showNotification("Belum ada data lubang yang diisi!", true);
            return;
        }
        
        if (!signaturePad || signaturePad.isEmpty()) {
            showNotification("Tanda tangan belum diisi!", true);
            return;
        }
        
        if (!currentNorthDirection) {
            showNotification("Arah utara belum dipilih!", true);
            return;
        }
        
        // Simpan ke database (otomatis untuk semua user)
        saveReportToDatabase();
        
        // Tampilkan notifikasi sukses
        showNotification("‚úÖ Laporan berhasil disimpan ke database! Data dapat diakses oleh semua user.");
        
        // Refresh database view
        loadDatabaseData();
        
        // Redirect ke database section
        setTimeout(() => {
            showSection('database');
        }, 2000);
    }

    function getJadwal(pit) {
        if (pit === 'Tempudo 4') {
            return '12:00-13:00 WITA';
        } else if (pit === 'Tempudo 2' || pit === 'Tempudo 3') {
            return '13:00-14:00 WITA';
        }
        return 'Jadwal Tidak Diketahui';
    }

    function updateReportData() {
        // Update report header data
        document.getElementById('report_tanggal').textContent = document.getElementById('tanggal').value || '-';
        document.getElementById('report_shift').textContent = document.getElementById('shift').value || '-';
        document.getElementById('report_pit').textContent = document.getElementById('pit').value || '-';
        document.getElementById('report_lokasi').textContent = document.getElementById('lokasi').value || '-';
        document.getElementById('report_planHole').textContent = document.getElementById('planHole').value || '-';
        
        const burden = document.getElementById('burden').value || '-';
        const spasi = document.getElementById('spasi').value || '-';
        document.getElementById('report_geometri').textContent = `${burden} x ${spasi}`;
        
        document.getElementById('report_unit').textContent = document.getElementById('unitDrilling').value || '-';
        document.getElementById('report_north_direction').textContent = currentNorthDirection ? currentNorthDirection.toUpperCase() : 'BELUM DIPILIH';
        
        // Update signature in report
        const signatureImg = document.getElementById('report_signature_img');
        if (signaturePad && !signaturePad.isEmpty()) {
            // Create a clean version of the signature for PDF
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 200;
            tempCanvas.height = 80;
            const tempCtx = tempCanvas.getContext('2d');
            
            // White background
            tempCtx.fillStyle = 'white';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // Draw signature
            tempCtx.drawImage(signaturePad.canvas, 0, 0, tempCanvas.width, tempCanvas.height);
            
            signatureImg.src = tempCanvas.toDataURL();
            signatureImg.style.display = 'block';
        } else {
            signatureImg.style.display = 'none';
        }
        
        // Update crew name
        document.getElementById('report_crew_name').textContent = document.getElementById('namaCrew').value || '(Nama Crew)';
        
        // Update copy-paste output dengan format yang benar
        updateCopyOutput();
    }

    function updateCopyOutput() {
        const stats = calculateStatistics();
        const pit = document.getElementById('pit').value;
        const shift = document.getElementById('shift').value;
        const lokasi = document.getElementById('lokasi').value;
        const planHole = document.getElementById('planHole').value;
        const burden = document.getElementById('burden').value;
        const spasi = document.getElementById('spasi').value;
        const unitDrilling = document.getElementById('unitDrilling').value;
        
        const jadwal = getJadwal(pit);
        
        // Format sesuai permintaan
        const outputText = `${pit} - ${shift}
‚è∞ JADWAL PELAKSANAAN PELEDAKAN : ${jadwal}

${lokasi}
Plan : ${planHole} hole
Actual : ${stats.totalHoles} hole
Depth : ${stats.avgDepth} m
Dry : ${stats.dryPercentage} %
Geometri : ${burden} x ${spasi}
Diameter : 171 mm
Unit : ${unitDrilling}
Arah Utara : ${currentNorthDirection ? currentNorthDirection.toUpperCase() : 'BELUM DIPILIH'}
            `.trim();

        document.getElementById('copyOutputText').value = outputText;
        document.getElementById('report_summary_text').textContent = outputText;
        document.getElementById('copyOutputContainer').classList.remove('hidden');
    }

    // Make functions globally available
    window.loadReportToForm = loadReportToForm;
    window.viewReportGrid = viewReportGrid;
    window.deleteReport = deleteReport;
    window.closeGridModal = closeGridModal;
    window.downloadReportPDF = downloadReportPDF;
    </script>

</body>
</html>
